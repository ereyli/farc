<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>$FARC Presale</title>
  <link rel="icon" href="/farc.png" />
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/frame-sdk';

    const CONTRACT_ADDRESS = "0x638eeea689d3f9678f8753f8ed1d55776f4129cd";
    const ABI = [
      "function buyTokens() payable",
      "function getPresaleInfo() view returns (bool,uint256,uint256,uint256)"
    ];

    let provider, signer, contract;

    async function initApp() {
      const errorBox = document.getElementById("errorBox");
      const buyBtn = document.getElementById("buyBtn");
      const amountInput = document.getElementById("amount");
      const soldDisplay = document.getElementById("sold");

      try {
        await sdk.actions.ready();

        provider = sdk.wallet?.ethProvider;
        if (!provider) {
          if (window.ethereum) provider = new ethers.providers.Web3Provider(window.ethereum);
          else throw new Error("No wallet provider available");
        } else {
          provider = new ethers.providers.Web3Provider(provider);
        }

        signer = provider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        // Show presale info
        const [isActive, sold, remaining, price] = await contract.getPresaleInfo();
        if (!isActive) throw new Error("Presale not active");
        soldDisplay.innerText = `${(Number(sold) / 1e6).toFixed(0)}M sold`;

        // Bind click
        buyBtn.onclick = async () => {
          try {
            errorBox.style.display = "none";
            const ethAmount = parseFloat(amountInput.value);
            if (isNaN(ethAmount) || ethAmount <= 0 || ethAmount > 0.05) {
              throw new Error("Enter a valid ETH amount (max 0.05)");
            }

            const tx = await contract.buyTokens({ value: ethers.utils.parseEther(ethAmount.toString()) });
            alert(`âœ… Tx sent: ${tx.hash}`);
          } catch (e) {
            console.error(e);
            errorBox.innerText = e.message || "Transaction failed";
            errorBox.style.display = "block";
          }
        };

      } catch (e) {
        console.error(e);
        errorBox.innerText = e.message || "Initialization error";
        errorBox.style.display = "block";
        buyBtn.disabled = true;
      }
    }

    window.addEventListener("DOMContentLoaded", initApp);
  </script>

  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(135deg, #8B5CF6, #6366F1);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .card {
      background: rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 20px;
      max-width: 400px;
      margin: auto;
    }

    input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 16px;
    }

    .button {
      background: #10b981;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px;
      font-size: 16px;
      margin-top: 15px;
      width: 100%;
      cursor: pointer;
    }

    .error {
      background: rgba(239, 68, 68, 0.2);
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="card">
    <img src="/farc.png" alt="FARC Logo" width="100" style="border-radius: 16px;" />
    <h1>$FARC Presale</h1>
    <p>0.01 ETH = 1M FARC</p>
    <p id="sold">Loading...</p>
    <input id="amount" type="number" placeholder="ETH Amount (e.g. 0.01)" step="0.001" />
    <button id="buyBtn" class="button">Buy $FARC ðŸš€</button>
    <div id="errorBox" class="error"></div>
  </div>
</body>
</html>
