<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>$FARC - The Farcaster Token</title>
  <link rel="icon" href="/farc.png" />
  <link rel="manifest" href="/farcaster.json" />

  <!-- Farcaster Mini App Meta -->
  <meta name="fc:frame" content="vNext">
  <meta name="fc:frame:image" content="https://farc.vercel.app/farc.png">
  <meta name="fc:frame:button:1" content="Launch App">
  <meta name="fc:frame:button:1:action" content="launch_frame">
  <meta name="fc:frame:button:1:target" content="https://farc.vercel.app">

  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);
      color: white;
      padding: 20px;
      min-height: 100vh;
    }
    .container { max-width: 400px; margin: 0 auto; }
    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      margin-top: 30px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    input {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 16px;
    }
    button {
      width: 100%;
      padding: 15px;
      background: #10b981;
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
    }
    .error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      display: none;
    }
    .error:not(.hidden) { display: block; }
    .wallet-info {
      text-align: center;
      margin-bottom: 10px;
      font-size: 14px;
      opacity: 0.8;
    }
    .progress-container {
      background: rgba(255,255,255,0.1);
      height: 10px;
      width: 100%;
      border-radius: 5px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-bar {
      background: #10b981;
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>$FARC Presale</h1>
    <p>0.01 ETH = 1M FARC â€” Max 5M per wallet</p>

    <div class="card">
      <input type="number" id="amount-input" step="0.001" placeholder="ETH amount (max 0.05)">
      <div class="wallet-info" id="wallet-info">Not connected</div>
      <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
      <button id="action-button" onclick="buyTokens()">Buy FARC ðŸš€</button>
      <div id="error-message" class="error hidden"></div>
    </div>
  </div>

  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/frame-sdk';
    sdk.actions.ready();
  </script>

  <script>
    const CONTRACT_ADDRESS = '0x638eeea689d3f9678f8753f8ed1d55776f4129cd';
    const CONTRACT_ABI = [
      'function buyTokens() external payable',
      'function getPresaleInfo() view returns (bool,uint256,uint256,uint256)',
      'function purchasedAmount(address) view returns (uint256)'
    ];

    let provider = window.ethereum;
    let userAddress = null;

    async function connect() {
      const accounts = await provider.request({ method: 'eth_requestAccounts' });
      userAddress = accounts[0];
      document.getElementById('wallet-info').textContent = `Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
      updateProgress();
    }

    async function buyTokens() {
      const amountInput = document.getElementById('amount-input');
      const amount = amountInput.value;

      if (!amount || parseFloat(amount) <= 0) {
        return showError("Please enter a valid amount");
      }

      if (parseFloat(amount) > 0.05) {
        return showError("Maximum 0.05 ETH (5M FARC)");
      }

      try {
        hideError();
        const button = document.getElementById('action-button');
        button.textContent = 'Processing...';
        button.disabled = true;

        await connect();
        const ethAmount = ethers.utils.parseEther(amount);
        const signer = new ethers.providers.Web3Provider(provider).getSigner();
        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        const purchased = await contract.purchasedAmount(userAddress);
        const max = ethers.utils.parseUnits('5000000', 18);
        const toBuy = ethAmount.mul(ethers.BigNumber.from('100000000'));

        if (purchased.add(toBuy).gt(max)) {
          showError("Exceeds max tokens per wallet");
          return;
        }

        const tx = await contract.buyTokens({ value: ethAmount });
        console.log("Transaction sent:", tx.hash);

        alert(`âœ… Transaction sent!\n\nTx Hash: ${tx.hash}`);
        amountInput.value = '';
        updateProgress();
      } catch (error) {
        console.error("Buy error:", error);
        if (error.code === 4001) showError("Transaction cancelled");
        else showError(error.message || "Transaction failed");
      } finally {
        const button = document.getElementById('action-button');
        button.textContent = 'Buy FARC ðŸš€';
        button.disabled = false;
      }
    }

    async function updateProgress() {
      try {
        const providerObj = new ethers.providers.Web3Provider(provider);
        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, providerObj);
        const [, sold, remaining] = await contract.getPresaleInfo();
        const total = sold.add(remaining);
        const percent = sold.mul(100).div(total);
        document.getElementById('progress-bar').style.width = `${percent.toString()}%`;
      } catch (e) {
        console.error("Progress update failed:", e);
      }
    }

    function showError(message) {
      const errorEl = document.getElementById('error-message');
      errorEl.textContent = message;
      errorEl.classList.remove('hidden');
    }

    function hideError() {
      const errorEl = document.getElementById('error-message');
      errorEl.classList.add('hidden');
    }
  </script>
</body>
</html>
