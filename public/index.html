<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>$FARC - The Farcaster Token</title>
    <link rel="icon" type="image/png" href="/farc.png">
    <link rel="manifest" href="/farcaster.json">
    
    <!-- Farcaster Mini App Meta -->
    <meta name="fc:frame" content="vNext">
    <meta name="fc:frame:image" content="https://farc.vercel.app/farc.png">
    <meta name="fc:frame:button:1" content="Launch App">
    <meta name="fc:frame:button:1:action" content="launch_frame">
    <meta name="fc:frame:button:1:target" content="https://farc.vercel.app">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            width: 120px;
            height: 120px;
            border-radius: 20px;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            touch-action: manipulation;
        }
        
        .button-primary {
            background: #10b981;
            color: white;
        }
        
        .button-primary:active {
            background: #059669;
            transform: scale(0.98);
        }
        
        .button-primary:disabled {
            background: #6b7280;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .button-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            margin-top: 10px;
        }
        
        .button-secondary:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.98);
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .wallet-info {
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
            opacity: 0.8;
        }
        
        .wallet-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.4);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            -webkit-appearance: none;
        }
        
        input[type="number"]::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            text-align: center;
        }
        
        .mobile-warning {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid rgba(251, 191, 36, 0.4);
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }
        
        .mobile-warning h3 {
            margin-bottom: 10px;
        }
        
        .mobile-warning p {
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            <h2>Loading $FARC...</h2>
        </div>
        
        <div id="app" class="hidden">
            <div class="header">
                <img src="/farc.png" alt="FARC Logo" class="logo" onerror="this.style.display='none'">
                <h1>$FARC</h1>
                <p id="header-text">The Official Farcaster Token</p>
                <p style="font-size: 14px; opacity: 0.8; margin-top: 5px;">üü£ Farcaster Exclusive</p>
            </div>
            
            <div id="mobile-warning" class="mobile-warning hidden">
                <h3>üì± Mobile Browser Detected</h3>
                <p>For the best experience, please use:</p>
                <ul style="text-align: left; margin: 10px 0; padding-left: 20px;">
                    <li>Warpcast app (recommended)</li>
                    <li>MetaMask mobile browser</li>
                    <li>Desktop browser with wallet</li>
                </ul>
            </div>
            
            <div class="card">
                <h2>üî• Presale LIVE</h2>
                <div class="info-row">
                    <span>Network:</span>
                    <strong>Base (Chain ID: 8453)</strong>
                </div>
                <div class="info-row">
                    <span>Price:</span>
                    <strong>0.01 ETH = 1M FARC</strong>
                </div>
                <div class="info-row">
                    <span>Max per wallet:</span>
                    <strong>5M FARC</strong>
                </div>
                <div class="info-row">
                    <span>Sold:</span>
                    <strong id="tokens-sold">125M / 500M</strong>
                </div>
            </div>
            
            <div class="card">
                <h3>Buy $FARC</h3>
                
                <div id="presale-status" style="text-align: center; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; display: none;">
                    <span id="presale-status-text"></span>
                </div>
                
                <div id="error-message" class="error hidden"></div>
                
                <input 
                    type="number" 
                    id="amount-input" 
                    placeholder="Amount in ETH (e.g. 0.01)"
                    step="0.001"
                    min="0.001"
                    max="0.05"
                    inputmode="decimal"
                >
                
                <div id="wallet-info" class="wallet-info"></div>
                
                <button id="action-button" class="button button-primary">
                    Loading...
                </button>
                
                <button class="button button-secondary" onclick="window.shareToken()">
                    Share $FARC üì¢
                </button>
            </div>
        </div>
    </div>

    <script>
        // Polyfill for BigInt if needed
        if (typeof BigInt === 'undefined') {
            window.BigInt = function(value) {
                return value;
            };
        }
        
        // Contract configuration
        const CONTRACT_ADDRESS = '0x638eeea689d3f9678f8753f8ed1d55776f4129cd';
        const CONTRACT_ABI = [
            'function buyTokens() external payable',
            'function purchasedAmount(address) view returns (uint256)',
            'function getRemainingPurchaseAmount(address) view returns (uint256)',
            'function getPresaleInfo() view returns (bool isActive, uint256 sold, uint256 remaining, uint256 pricePerMillion)',
            'function balanceOf(address) view returns (uint256)',
            'function decimals() view returns (uint8)'
        ];
        
        // Global state
        let provider = null;
        let userAddress = null;
        let isConnected = false;
        let farcasterContext = null;
        let sdk = null;
        let isMobile = false;
        
        // Check if mobile
        function checkMobile() {
            isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            console.log('Is mobile:', isMobile);
            
            // Check for wallet apps
            const isMetaMask = typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask;
            const isWarpcast = window.location.href.includes('warpcast') || navigator.userAgent.includes('Warpcast');
            
            console.log('MetaMask detected:', isMetaMask);
            console.log('Warpcast detected:', isWarpcast);
            
            return { isMobile, isMetaMask, isWarpcast };
        }
        
        // Load Farcaster SDK dynamically
        async function loadFarcasterSDK() {
            try {
                // Try to load the SDK
                const module = await import('https://esm.sh/@farcaster/frame-sdk');
                sdk = module.sdk;
                console.log('Farcaster SDK loaded successfully');
                return true;
            } catch (error) {
                console.log('Failed to load Farcaster SDK:', error);
                return false;
            }
        }
        
        // Initialize app
        async function init() {
            console.log('Initializing FARC app...');
            
            try {
                const mobileCheck = checkMobile();
                
                // Show mobile warning if needed
                if (mobileCheck.isMobile && !mobileCheck.isMetaMask && !mobileCheck.isWarpcast) {
                    document.getElementById('mobile-warning').classList.remove('hidden');
                }
                
                // Try to load Farcaster SDK
                const sdkLoaded = await loadFarcasterSDK();
                
                if (sdkLoaded && sdk) {
                    try {
                        // Initialize Farcaster SDK
                        console.log('Initializing SDK...');
                        await sdk.actions.ready();
                        console.log('SDK ready');
                        
                        // Get Farcaster context
                        try {
                            farcasterContext = await sdk.context;
                            console.log('Context received:', farcasterContext);
                            
                            // Update UI with user info
                            if (farcasterContext?.user?.username) {
                                document.getElementById('header-text').innerHTML = 
                                    `The Official Farcaster Token<br><small>üë§ @${farcasterContext.user.username}</small>`;
                            }
                        } catch (contextError) {
                            console.log('Context error (non-fatal):', contextError);
                        }
                        
                        // Get wallet provider from Farcaster SDK
                        provider = sdk.wallet?.ethProvider;
                    } catch (sdkError) {
                        console.log('SDK initialization error:', sdkError);
                    }
                }
                
                // Fallback to window.ethereum if no SDK provider
                if (!provider && window.ethereum) {
                    provider = window.ethereum;
                    console.log('Using window.ethereum as provider');
                }
                
                if (!provider) {
                    console.log('No wallet provider available');
                    if (mobileCheck.isMobile) {
                        showError('Please open in Warpcast app or MetaMask browser');
                    } else {
                        showError('Please install a wallet extension');
                    }
                    disableActions();
                } else {
                    // Check if already connected
                    try {
                        const accounts = await provider.request({ method: 'eth_accounts' });
                        console.log('Existing accounts:', accounts);
                        
                        if (accounts && accounts.length > 0) {
                            await handleConnection(accounts[0]);
                        } else {
                            updateUIForDisconnected();
                        }
                    } catch (accountError) {
                        console.log('Account check error:', accountError);
                        updateUIForDisconnected();
                    }
                    
                    // Listen for account changes
                    if (provider.on) {
                        provider.on('accountsChanged', handleAccountsChanged);
                    }
                }
                
                // Load presale info
                await loadPresaleInfo();
                
            } catch (error) {
                console.error('Init error:', error);
                showError('Initialization error: ' + error.message);
                updateUIForDisconnected();
            } finally {
                // Hide loading, show app
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            }
        }
        
        // Handle account changes
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                userAddress = null;
                isConnected = false;
                updateUIForDisconnected();
            } else if (accounts[0] !== userAddress) {
                handleConnection(accounts[0]);
            }
        }
        
        // Load presale info from contract
        async function loadPresaleInfo() {
            try {
                if (!provider) return;
                
                // Create a simple contract interface for reading
                const request = {
                    to: CONTRACT_ADDRESS,
                    data: '0x5a3b74a0' // getPresaleInfo() function selector
                };
                
                try {
                    const result = await provider.request({
                        method: 'eth_call',
                        params: [request, 'latest']
                    });
                    
                    if (result && result !== '0x') {
                        // Extract isActive (first 32 bytes after '0x')
                        const isActive = result.slice(2, 66) === '0'.repeat(63) + '1';
                        
                        if (!isActive) {
                            showError('‚ö†Ô∏è Presale is not active yet. Please wait for the owner to start it.');
                            document.getElementById('action-button').disabled = true;
                        }
                        
                        // Extract sold amount (second 32 bytes)
                        const soldHex = '0x' + result.slice(66, 130);
                        const sold = parseInt(soldHex, 16) / 1e18;
                        
                        // Extract remaining amount (third 32 bytes)
                        const remainingHex = '0x' + result.slice(130, 194);
                        const remaining = parseInt(remainingHex, 16) / 1e18;
                        
                        const total = sold + remaining;
                        
                        document.getElementById('tokens-sold').textContent = 
                            `${(sold / 1e6).toFixed(0)}M / ${(total / 1e6).toFixed(0)}M`;
                    }
                } catch (callError) {
                    console.error('Contract call error:', callError);
                }
                
            } catch (error) {
                console.error('loadPresaleInfo error:', error);
            }
        }
        
        // Handle connection
        async function handleConnection(address) {
            console.log('Connected with address:', address);
            userAddress = address;
            isConnected = true;
            updateUIForConnected();
            hideError();
        }
        
        // Update UI for connected state
        function updateUIForConnected() {
            const walletInfo = document.getElementById('wallet-info');
            walletInfo.innerHTML = `
                <div class="wallet-badge">
                    <span>üü£</span>
                    <span>${userAddress.slice(0, 6)}...${userAddress.slice(-4)}</span>
                </div>
            `;
            
            const button = document.getElementById('action-button');
            button.textContent = 'Buy FARC üöÄ';
            button.onclick = buyTokens;
            button.disabled = false;
        }
        
        // Update UI for disconnected state
        function updateUIForDisconnected() {
            const walletInfo = document.getElementById('wallet-info');
            walletInfo.innerHTML = '';
            
            const button = document.getElementById('action-button');
            button.textContent = 'Connect Wallet';
            button.onclick = connectWallet;
            button.disabled = false;
        }
        
        // Disable actions
        function disableActions() {
            const button = document.getElementById('action-button');
            button.disabled = true;
            button.textContent = 'Wallet Not Available';
        }
        
        // Connect wallet
        async function connectWallet() {
            console.log('Connect wallet clicked');
            
            if (!provider) {
                if (isMobile) {
                    // Provide specific mobile instructions
                    if (confirm('No wallet detected. Open in MetaMask browser?')) {
                        window.location.href = `https://metamask.app.link/dapp/${window.location.href}`;
                    }
                } else {
                    showError('Please install MetaMask or another wallet');
                }
                return;
            }
            
            try {
                hideError();
                const button = document.getElementById('action-button');
                button.textContent = 'Connecting...';
                button.disabled = true;
                
                // Check network first
                const chainId = await provider.request({ method: 'eth_chainId' });
                console.log('Current chain ID:', chainId);
                
                // Base chain ID is 8453 (0x2105 in hex)
                if (chainId !== '0x2105' && parseInt(chainId, 16) !== 8453) {
                    console.log('Wrong network, requesting switch to Base...');
                    try {
                        await provider.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x2105' }]
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            // Chain not added, try to add it
                            try {
                                await provider.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0x2105',
                                        chainName: 'Base',
                                        nativeCurrency: {
                                            name: 'Ether',
                                            symbol: 'ETH',
                                            decimals: 18
                                        },
                                        rpcUrls: ['https://mainnet.base.org'],
                                        blockExplorerUrls: ['https://basescan.org']
                                    }]
                                });
                            } catch (addError) {
                                console.error('Add chain error:', addError);
                                showError('Please add Base network to your wallet');
                                updateUIForDisconnected();
                                return;
                            }
                        } else {
                            console.error('Network switch error:', switchError);
                            showError('Please switch to Base network');
                            updateUIForDisconnected();
                            return;
                        }
                    }
                }
                
                console.log('Requesting accounts...');
                const accounts = await provider.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                console.log('Accounts received:', accounts);
                
                if (accounts && accounts.length > 0) {
                    await handleConnection(accounts[0]);
                } else {
                    showError('No accounts found');
                    updateUIForDisconnected();
                }
                
            } catch (error) {
                console.error('Connect error:', error);
                if (error.code === 4001) {
                    showError('Connection cancelled');
                } else {
                    showError('Failed to connect wallet');
                }
                updateUIForDisconnected();
            }
        }
        
        // Buy tokens
        async function buyTokens() {
            const amountInput = document.getElementById('amount-input');
            const amount = amountInput.value;
            
            if (!amount || parseFloat(amount) <= 0) {
                showError('Please enter a valid amount');
                return;
            }
            
            if (parseFloat(amount) > 0.05) {
                showError('Maximum 0.05 ETH (5M FARC)');
                return;
            }
            
            try {
                hideError();
                const button = document.getElementById('action-button');
                button.textContent = 'Processing...';
                button.disabled = true;
                
                // Calculate tokens
                const ethAmount = parseFloat(amount);
                const tokensToReceive = ethAmount * 100; // 100M tokens per ETH
                
                // Convert ETH to wei - handle BigInt compatibility
                let hexValue;
                try {
                    const weiAmount = BigInt(Math.floor(ethAmount * 1e18));
                    hexValue = '0x' + weiAmount.toString(16);
                } catch (e) {
                    // Fallback for browsers without BigInt
                    const weiAmount = Math.floor(ethAmount * 1e18);
                    hexValue = '0x' + weiAmount.toString(16);
                }
                
                console.log('ETH amount:', ethAmount);
                console.log('Hex value:', hexValue);
                
                // Prepare transaction
                const transaction = {
                    to: CONTRACT_ADDRESS,
                    from: userAddress,
                    value: hexValue,
                    data: '0xec8ac4d8' // buyTokens() function selector
                };
                
                console.log('Sending transaction:', transaction);
                
                // Send transaction
                const txHash = await provider.request({
                    method: 'eth_sendTransaction',
                    params: [transaction]
                });
                
                console.log('Transaction sent:', txHash);
                
                alert(
                    `‚úÖ Transaction Sent!\n\n` +
                    `You will receive: ${tokensToReceive}M FARC\n` +
                    `Tx Hash: ${txHash.slice(0, 10)}...${txHash.slice(-8)}\n\n` +
                    `View on BaseScan`
                );
                
                // Clear input
                amountInput.value = '';
                
                // Reload presale info after a delay
                setTimeout(() => {
                    loadPresaleInfo();
                }, 5000);
                
            } catch (error) {
                console.error('Buy error:', error);
                
                if (error.code === 4001) {
                    showError('Transaction cancelled');
                } else if (error.code === -32000) {
                    showError('Insufficient funds for gas + amount');
                } else if (error.message?.includes('insufficient funds')) {
                    showError('Insufficient ETH balance');
                } else if (error.message?.includes('execution reverted')) {
                    showError('Transaction failed - check purchase limits');
                } else {
                    showError('Transaction failed: ' + (error.message || error.code || 'Unknown error'));
                }
            } finally {
                updateUIForConnected();
            }
        }
        
        // Show error
        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }
        
        // Hide error
        function hideError() {
            const errorEl = document.getElementById('error-message');
            errorEl.classList.add('hidden');
        }
        
        // Share function
        window.shareToken = function() {
            const text = 'Check out $FARC - The Official Farcaster Token! üöÄ\n\nPresale: 0.01 ETH = 1M FARC\nMax 5M per wallet\n\nüü£ Farcaster exclusive\n\nhttps://farc.vercel.app';
            
            if (navigator.share && isMobile) {
                navigator.share({
                    title: '$FARC Token',
                    text: text
                }).catch(() => {
                    copyToClipboard(text);
                });
            } else {
                copyToClipboard(text);
            }
        }
        
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                alert('Share text copied!');
            } catch (err) {
                alert('Failed to copy');
            }
            
            document.body.removeChild(textarea);
        }
        
        // Start app when DOM is loaded
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
