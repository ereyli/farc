<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$FARC - The Farcaster Token</title>
    <link rel="icon" type="image/png" href="/farc.png">
    <link rel="manifest" href="/farcaster.json">
    
    <!-- Farcaster Mini App Meta -->
    <meta name="fc:frame" content="vNext">
    <meta name="fc:frame:image" content="https://farc.vercel.app/farc.png">
    <meta name="fc:frame:button:1" content="Launch App">
    <meta name="fc:frame:button:1:action" content="launch_frame">
    <meta name="fc:frame:button:1:target" content="https://farc.vercel.app">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            width: 120px;
            height: 120px;
            border-radius: 20px;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .button-primary {
            background: #10b981;
            color: white;
        }
        
        .button-primary:hover {
            background: #059669;
        }
        
        .button-primary:disabled {
            background: #6b7280;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .button-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            margin-top: 10px;
        }
        
        .button-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .hidden {
            display: none;
        }
        
        .wallet-info {
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
            opacity: 0.8;
        }
        
        .wallet-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.4);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }
        
        input[type="number"]::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            <h2>Loading $FARC...</h2>
        </div>
        
        <div id="app" class="hidden">
            <div class="header">
                <img src="/farc.png" alt="FARC Logo" class="logo">
                <h1>$FARC</h1>
                <p id="header-text">The Official Farcaster Token</p>
                <p style="font-size: 14px; opacity: 0.8; margin-top: 5px;">🟣 Farcaster Exclusive</p>
            </div>
            
            <div class="card">
                <h2>🔥 Presale LIVE</h2>
                <div class="info-row">
                    <span>Network:</span>
                    <strong>Base (Chain ID: 8453)</strong>
                </div>
                <div class="info-row">
                    <span>Price:</span>
                    <strong>0.01 ETH = 1M FARC</strong>
                </div>
                <div class="info-row">
                    <span>Max per wallet:</span>
                    <strong>5M FARC</strong>
                </div>
                <div class="info-row">
                    <span>Sold:</span>
                    <strong id="tokens-sold">125M / 500M</strong>
                </div>
            </div>
            
            <div class="card">
                <h3>Buy $FARC</h3>
                
                <div id="presale-status" style="text-align: center; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; display: none;">
                    <span id="presale-status-text"></span>
                </div>
                
                <div id="error-message" class="error hidden"></div>
                
                <div style="margin: 15px 0;">
                    <label style="font-size: 14px; opacity: 0.8;">Select amount:</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 10px 0;">
                        <button onclick="window.setAmount(0.001)" class="button button-secondary" style="padding: 10px; font-size: 14px;">
                            0.001 ETH
                        </button>
                        <button onclick="window.setAmount(0.01)" class="button button-secondary" style="padding: 10px; font-size: 14px;">
                            0.01 ETH
                        </button>
                        <button onclick="window.setAmount(0.05)" class="button button-secondary" style="padding: 10px; font-size: 14px;">
                            0.05 ETH
                        </button>
                    </div>
                </div>
                
                <input 
                    type="number" 
                    id="amount-input" 
                    placeholder="Amount in ETH"
                    step="0.001"
                    min="0.001"
                    max="0.05"
                    value="0.001"
                    readonly
                >
                
                <div id="wallet-info" class="wallet-info"></div>
                
                <button id="action-button" class="button button-primary">
                    Loading...
                </button>
                
                <button class="button button-secondary" onclick="window.shareToken()">
                    Share $FARC 📢
                </button>
                
                <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 12px; text-align: center;">
                    <p style="margin: 5px 0;">Having issues? Try:</p>
                    <p style="margin: 5px 0;">• Use preset amounts above</p>
                    <p style="margin: 5px 0;">• Refresh the app</p>
                    <p style="margin: 5px 0;">• <a href="https://basescan.org/address/0x638EeEa689d3f9678f8753F8Ed1d55776F4129Cd#writeContract" target="_blank" style="color: #10b981;">Buy on BaseScan</a></p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { sdk } from 'https://esm.sh/@farcaster/frame-sdk';
        
        // Contract configuration
        const CONTRACT_ADDRESS = '0x638EeEa689d3f9678f8753F8Ed1d55776F4129Cd';
        const CONTRACT_ABI = [
            'function buyTokens() external payable',
            'function purchasedAmount(address) view returns (uint256)',
            'function getRemainingPurchaseAmount(address) view returns (uint256)',
            'function getPresaleInfo() view returns (bool isActive, uint256 sold, uint256 remaining, uint256 pricePerMillion)',
            'function balanceOf(address) view returns (uint256)',
            'function decimals() view returns (uint8)'
        ];
        
        // Global state
        let provider = null;
        let userAddress = null;
        let isConnected = false;
        let farcasterContext = null;
        
        // Initialize app
        async function init() {
            console.log('Initializing FARC app...');
            
            try {
                // Initialize Farcaster SDK
                console.log('Step 1: Initializing SDK...');
                await sdk.actions.ready();
                console.log('Step 2: SDK ready');
                
                // Get Farcaster context
                try {
                    console.log('Step 3: Getting context...');
                    farcasterContext = await sdk.context;
                    console.log('Step 4: Context received:', farcasterContext);
                    
                    // Update UI with user info
                    if (farcasterContext?.user?.username) {
                        document.getElementById('header-text').innerHTML = 
                            `The Official Farcaster Token<br><small>👤 @${farcasterContext.user.username}</small>`;
                    }
                } catch (contextError) {
                    console.log('Context error (non-fatal):', contextError);
                }
                
                // Get wallet provider from Farcaster SDK
                console.log('Step 5: Getting wallet provider...');
                provider = sdk.wallet?.ethProvider;
                
                if (!provider) {
                    console.log('No wallet provider in SDK, trying window.ethereum...');
                    // Fallback to window.ethereum if available
                    if (window.ethereum) {
                        provider = window.ethereum;
                        console.log('Using window.ethereum as provider');
                    } else {
                        console.log('No wallet provider available');
                        showError('Please open this app in Warpcast');
                        disableActions();
                        return;
                    }
                }
                
                console.log('Step 6: Provider found:', provider);
                
                // Check if already connected
                try {
                    console.log('Step 7: Checking existing accounts...');
                    const accounts = await provider.request({ method: 'eth_accounts' });
                    console.log('Step 8: Accounts:', accounts);
                    
                    if (accounts && accounts.length > 0) {
                        await handleConnection(accounts[0]);
                    } else {
                        updateUIForDisconnected();
                    }
                } catch (accountError) {
                    console.log('Account check error:', accountError);
                    updateUIForDisconnected();
                }
                
                // Listen for account changes
                if (provider.on) {
                    provider.on('accountsChanged', handleAccountsChanged);
                }
                
                // Load presale info
                console.log('Step 9: Loading presale info...');
                await loadPresaleInfo();
                console.log('Step 10: Init complete!');
                
            } catch (error) {
                console.error('Init error details:', error);
                console.error('Error stack:', error.stack);
                showError('Initialization error: ' + error.message);
                // Don't disable actions, allow manual connect
                updateUIForDisconnected();
            } finally {
                // Hide loading, show app
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            }
        }
        
        // Load presale info from contract
        async function loadPresaleInfo() {
            try {
                console.log('loadPresaleInfo: Starting...');
                if (!provider) {
                    console.log('loadPresaleInfo: No provider, skipping');
                    return;
                }
                
                // Enable contract calls
                console.log('loadPresaleInfo: Checking presale status...');
                
                // Create a simple contract interface for reading
                const request = {
                    to: CONTRACT_ADDRESS,
                    data: '0x5a3b74a0' // getPresaleInfo() function selector
                };
                
                try {
                    const result = await provider.request({
                        method: 'eth_call',
                        params: [request, 'latest']
                    });
                    
                    console.log('Presale info raw result:', result);
                    
                    // Decode result (bool isActive, uint256 sold, uint256 remaining, uint256 pricePerMillion)
                    if (result && result !== '0x') {
                        // Extract isActive (first 32 bytes after '0x')
                        const isActive = result.slice(2, 66) === '0'.repeat(63) + '1';
                        console.log('Presale active:', isActive);
                        
                        if (!isActive) {
                            showError('⚠️ Presale is not active yet. Please wait for the owner to start it.');
                            document.getElementById('action-button').disabled = true;
                        }
                        
                        // Extract sold amount (second 32 bytes)
                        const soldHex = '0x' + result.slice(66, 130);
                        const sold = parseInt(soldHex, 16) / 1e18;
                        
                        // Extract remaining amount (third 32 bytes)
                        const remainingHex = '0x' + result.slice(130, 194);
                        const remaining = parseInt(remainingHex, 16) / 1e18;
                        
                        const total = sold + remaining;
                        
                        document.getElementById('tokens-sold').textContent = 
                            `${(sold / 1e6).toFixed(0)}M / ${(total / 1e6).toFixed(0)}M`;
                    }
                } catch (callError) {
                    console.error('Contract call error:', callError);
                    // Don't show error, just use static data
                }
                
                // Load user's purchased amount if connected
                if (isConnected && userAddress) {
                    await loadUserInfo();
                }
                
            } catch (error) {
                console.error('loadPresaleInfo error:', error);
                // Don't throw, just log
            }
        }
        
        // Load user info
        async function loadUserInfo() {
            try {
                console.log('loadUserInfo: Starting...');
                if (!provider || !userAddress) {
                    console.log('loadUserInfo: Missing provider or address');
                    return;
                }
                
                // Enable contract calls
                console.log('loadUserInfo: Checking user purchases...');
                
                try {
                    // Get user's purchased amount
                    const data = '0x81a73ad5' + userAddress.slice(2).padStart(64, '0'); // purchasedAmount(address)
                    
                    const request = {
                        to: CONTRACT_ADDRESS,
                        data: data
                    };
                    
                    const result = await provider.request({
                        method: 'eth_call',
                        params: [request, 'latest']
                    });
                    
                    if (result && result !== '0x') {
                        const purchased = parseInt(result, 16) / 1e18;
                        const remaining = 5e6 - purchased; // 5M max per wallet
                        
                        if (purchased > 0) {
                            const walletInfo = document.getElementById('wallet-info');
                            walletInfo.innerHTML += `
                                <div style="margin-top: 5px; font-size: 12px;">
                                    Purchased: ${(purchased / 1e6).toFixed(2)}M FARC | 
                                    Remaining: ${(remaining / 1e6).toFixed(2)}M FARC
                                </div>
                            `;
                        }
                    }
                } catch (callError) {
                    console.error('User info call error:', callError);
                }
                
            } catch (error) {
                console.error('loadUserInfo error:', error);
                // Don't throw, just log
            }
        }
        
        // Handle connection
        async function handleConnection(address) {
            console.log('Connected with address:', address);
            userAddress = address;
            isConnected = true;
            updateUIForConnected();
            hideError();
        }
        
        // Update UI for connected state
        function updateUIForConnected() {
            const walletInfo = document.getElementById('wallet-info');
            walletInfo.innerHTML = `
                <div class="wallet-badge">
                    <span>🟣</span>
                    <span>${userAddress.slice(0, 6)}...${userAddress.slice(-4)}</span>
                </div>
            `;
            
            const button = document.getElementById('action-button');
            button.textContent = 'Buy FARC 🚀';
            button.onclick = buyTokens;
            button.disabled = false;
        }
        
        // Update UI for disconnected state
        function updateUIForDisconnected() {
            const walletInfo = document.getElementById('wallet-info');
            walletInfo.innerHTML = '';
            
            const button = document.getElementById('action-button');
            button.textContent = 'Connect Wallet';
            button.onclick = connectWallet;
            button.disabled = false;
        }
        
        // Disable actions
        function disableActions() {
            const button = document.getElementById('action-button');
            button.disabled = true;
            button.textContent = 'Wallet Not Available';
        }
        
        // Connect wallet
        async function connectWallet() {
            console.log('Connect wallet clicked');
            
            if (!provider) {
                showError('Please open this app in Warpcast');
                return;
            }
            
            try {
                hideError();
                const button = document.getElementById('action-button');
                button.textContent = 'Connecting...';
                button.disabled = true;
                
                // Check network first
                const chainId = await provider.request({ method: 'eth_chainId' });
                console.log('Current chain ID:', chainId);
                
                // Base chain ID is 8453 (0x2105 in hex)
                if (chainId !== '0x2105' && parseInt(chainId, 16) !== 8453) {
                    console.log('Wrong network, requesting switch to Base...');
                    try {
                        await provider.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x2105' }]
                        });
                    } catch (switchError) {
                        console.error('Network switch error:', switchError);
                        showError('Please switch to Base network');
                        updateUIForDisconnected();
                        return;
                    }
                }
                
                console.log('Requesting accounts...');
                const accounts = await provider.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                console.log('Accounts received:', accounts);
                
                if (accounts && accounts.length > 0) {
                    await handleConnection(accounts[0]);
                } else {
                    showError('No accounts found');
                    updateUIForDisconnected();
                }
                
            } catch (error) {
                console.error('Connect error:', error);
                if (error.code === 4001) {
                    showError('Connection cancelled');
                } else {
                    showError('Failed to connect wallet');
                }
                updateUIForDisconnected();
            }
        }
        
        // Buy tokens
        async function buyTokens() {
            const amountInput = document.getElementById('amount-input');
            const amount = amountInput.value;
            
            if (!amount || parseFloat(amount) <= 0) {
                showError('Please enter a valid amount');
                return;
            }
            
            if (parseFloat(amount) > 0.05) {
                showError('Maximum 0.05 ETH (5M FARC)');
                return;
            }
            
            try {
                hideError();
                const button = document.getElementById('action-button');
                button.textContent = 'Processing...';
                button.disabled = true;
                
                // Calculate tokens
                const ethAmount = parseFloat(amount);
                const tokensToReceive = ethAmount * 100; // 100M tokens per ETH
                
                // Convert ETH to wei - use exact hex string
                let hexValue;
                if (ethAmount === 0.001) {
                    hexValue = '0x38d7ea4c68000'; // Exactly 0.001 ETH
                } else if (ethAmount === 0.01) {
                    hexValue = '0x2386f26fc10000'; // Exactly 0.01 ETH
                } else if (ethAmount === 0.05) {
                    hexValue = '0xb1a2bc2ec50000'; // Exactly 0.05 ETH
                } else {
                    // For other values, calculate
                    const weiValue = Math.floor(ethAmount * 1e18);
                    hexValue = '0x' + weiValue.toString(16);
                }
                
                console.log('Contract:', CONTRACT_ADDRESS);
                console.log('ETH amount:', ethAmount);
                console.log('Hex value:', hexValue);
                
                // Try the simplest possible transaction format
                const transaction = {
                    to: CONTRACT_ADDRESS.toLowerCase(), // Ensure lowercase
                    value: hexValue,
                    data: '0xec8ac4d8' // buyTokens() function selector
                };
                
                console.log('Transaction params:', JSON.stringify(transaction, null, 2));
                
                // Send transaction
                const txHash = await provider.request({
                    method: 'eth_sendTransaction',
                    params: [transaction]
                });
                
                console.log('Transaction sent:', txHash);
                
                // Success message
                showSuccess(
                    `✅ Transaction Sent!\n` +
                    `You will receive: ${tokensToReceive}M FARC\n` +
                    `Tx: ${txHash.slice(0, 10)}...${txHash.slice(-8)}`
                );
                
                // Clear input
                amountInput.value = '0.001';
                
                // Reload info after delay
                setTimeout(() => {
                    loadPresaleInfo();
                    loadUserInfo();
                }, 5000);
                
            } catch (error) {
                console.error('Transaction error:', error);
                
                // If Farcaster wallet fails, suggest alternative
                if (error.code === -32602 || error.code === -32000) {
                    showError(
                        'Farcaster wallet transaction failed. ' +
                        'Try: 1) Refresh the app, 2) Use exact amounts (0.001, 0.01, 0.05 ETH), ' +
                        '3) Or purchase directly from contract on BaseScan'
                    );
                } else if (error.code === 4001) {
                    showError('Transaction cancelled');
                } else {
                    showError('Transaction failed. Please try refreshing the app.');
                }
            } finally {
                const button = document.getElementById('action-button');
                button.textContent = 'Buy FARC 🚀';
                button.disabled = false;
            }
        }
        
        // Show error
        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }
        
        // Hide error
        function hideError() {
            const errorEl = document.getElementById('error-message');
            errorEl.classList.add('hidden');
        }
        
        // Share function
        window.shareToken = function() {
            const text = 'Check out $FARC - The Official Farcaster Token! 🚀\n\nPresale: 0.01 ETH = 1M FARC\nMax 5M per wallet\n\n🟣 Farcaster exclusive\n\nhttps://farc.vercel.app';
            
            if (navigator.share) {
                navigator.share({
                    title: '$FARC Token',
                    text: text
                }).catch(() => {
                    copyToClipboard(text);
                });
            } else {
                copyToClipboard(text);
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Share text copied!');
            }).catch(() => {
                alert('Failed to copy');
            });
        }
        
        // Start app when DOM is loaded
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
