<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>$FARC â€“ The Farcaster Token</title>

  <!-- Icons & Manifest -->
  <link rel="icon" type="image/png" href="/farc.png" />
  <link rel="manifest" href="/farcaster.json" />

  <!-- Farcaster Frame Meta -->
  <meta name="fc:frame" content="vNext" />
  <meta name="fc:frame:image" content="https://farc.vercel.app/farc.png" />
  <meta name="fc:frame:button:1" content="Launch App" />
  <meta name="fc:frame:button:1:action" content="launch_frame" />
  <meta name="fc:frame:button:1:target" content="https://farc.vercel.app" />

  <!-- Ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box }
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:linear-gradient(135deg,#8B5CF6 0%,#6366F1 100%); color:#fff; min-height:100vh; padding:20px }
    .container{max-width:400px;margin:0 auto}
    .header{text-align:center;margin-bottom:30px}
    .logo{width:120px;height:120px;border-radius:20px;margin-bottom:20px}
    h1{font-size:36px;margin-bottom:10px}
    .card{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border-radius:20px;padding:20px;margin-bottom:20px;border:1px solid rgba(255,255,255,.2)}
    .button{width:100%;padding:15px;border:none;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer;transition:.3s}
    .button-primary{background:#10b981;color:#fff}
    .button-primary:hover{background:#059669}
    .button-primary:disabled{background:#6b7280;cursor:not-allowed;opacity:.7}
    .button-secondary{background:rgba(255,255,255,.2);color:#fff;margin-top:10px}
    .button-secondary:hover{background:rgba(255,255,255,.3)}
    .button-amount{padding:10px;font-size:14px;background:rgba(139,92,246,.2);border:1px solid rgba(139,92,246,.4)}
    .button-amount:hover{background:rgba(139,92,246,.3)}
    .button-amount.active{background:rgba(139,92,246,.5);border-color:#8B5CF6}
    .info-row{display:flex;justify-content:space-between;margin-bottom:10px}
    .loading{text-align:center;padding:50px}
    .hidden{display:none}
    .wallet-info{text-align:center;margin:10px 0;font-size:14px;opacity:.8}
    .wallet-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(139,92,246,.2);border:1px solid rgba(139,92,246,.4);padding:8px 16px;border-radius:20px;font-size:14px}
    input[type=number]{width:100%;padding:12px;margin:10px 0;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.1);color:#fff;font-size:16px;text-align:center}
    input[type=number]::placeholder{color:rgba(255,255,255,.6)}
    .error{background:rgba(239,68,68,.2);border:1px solid rgba(239,68,68,.4);padding:10px;border-radius:8px;margin:10px 0;font-size:14px;text-align:center}
    .success{background:rgba(16,185,129,.2);border:1px solid rgba(16,185,129,.4);padding:10px;border-radius:8px;margin:10px 0;font-size:14px;text-align:center}
    .help-box{margin-top:15px;padding:10px;background:rgba(255,255,255,.05);border-radius:8px;font-size:12px;text-align:center}
    .help-box a{color:#10b981;text-decoration:none}
    .help-box a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading -->
    <div id="loading" class="loading"><h2>Loading $FARC...</h2></div>

    <!-- App -->
    <div id="app" class="hidden">
      <!-- ... (ORÄ°JÄ°NAL HTML Ä°Ã‡ERÄ°ÄžÄ°N DEÄžÄ°ÅžMEDEN KALDI) ... -->
    </div>
  </div>

  <!-- ðŸŒŸ Uygulama Script'leri -->
  <script>
    /* ------------- GLOBAL STATE ------------- */
    const CONTRACT_ADDRESS = '0x0148d27a8821115eb16062456369a693cc8d53ec';
    const CONTRACT_ABI = [
      'function buyTokens() external payable',
      'function getInfo() view returns (bool,uint256,uint256,uint256)',
      'function getRemainingAllocation(address) view returns (uint256)',
      'function purchasedAmount(address) view returns (uint256)'
    ];
    let provider, ethersProvider, signer, contract;
    let userAddress = null;
    let isFarcasterFrame = window !== window.parent;

    /* ------------- UI HELPERS ------------- */
    const $ = id => document.getElementById(id);
    function showApp() { $('loading').classList.add('hidden'); $('app').classList.remove('hidden'); }
    function showError(msg){ $('message-area').innerHTML=`<div class="error">${msg}</div>`; }
    function showSuccess(msg){ $('message-area').innerHTML=`<div class="success">${msg}</div>`; }
    function clearMsg(){ $('message-area').innerHTML=''; }

    /* ------------- WALLET & SDK INIT ------------- */
    async function initWallet(){
      if(isFarcasterFrame){
        const { sdk } = await import('https://esm.sh/@farcaster/frame-sdk');
        await sdk.actions.ready({ disableNativeGestures:true });
        window.sdk = sdk;
        provider = sdk.wallet?.ethProvider;
        if(!provider){ showError('Farcaster wallet unavailable'); return; }
      }else{
        if(!window.ethereum){ showError('Install MetaMask'); return; }
        provider = window.ethereum;
        ethersProvider = new ethers.providers.Web3Provider(provider);
      }
      attachAccountListeners();
      await tryAutoConnect();
    }

    function attachAccountListeners(){
      if(provider?.on){
        provider.on('accountsChanged', accs=> handleAccounts(accs[0]||null));
        provider.on('chainChanged', ()=> location.reload());
      }
    }

    async function tryAutoConnect(){
      const accounts = await provider.request({ method:'eth_accounts' });
      handleAccounts(accounts[0]||null);
    }

    async function connectWallet(){
      try{
        const acc = await provider.request({ method:'eth_requestAccounts' });
        handleAccounts(acc[0]);
      }catch(e){ showError('Connection cancelled'); }
    }

    async function handleAccounts(acc){
      if(!acc){ userAddress=null; updateDisconnected(); return; }
      userAddress = acc;
      if(!isFarcasterFrame){
        ethersProvider ??= new ethers.providers.Web3Provider(provider);
        signer = ethersProvider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
      }
      updateConnected();
      await loadPresaleInfo();
    }

    /* ------------- UI STATE ------------- */
    function updateConnected(){
      $('wallet-info').innerHTML=`<div class="wallet-badge"><span>ðŸŸ£</span><span>${userAddress.slice(0,6)}...${userAddress.slice(-4)}</span></div>`;
      const btn=$('action-button'); btn.textContent='Buy FARC ðŸš€'; btn.onclick=buyTokens; btn.disabled=false;
    }
    function updateDisconnected(){
      $('wallet-info').innerHTML='';
      const btn=$('action-button'); btn.textContent='Connect Wallet'; btn.onclick=connectWallet; btn.disabled=false;
    }

    /* ------------- BUY TOKENS ------------- */
    async function buyTokens(){
      const ethAmt=parseFloat($('amount-input').value||0);
      if(!ethAmt){ showError('Enter amount'); return; }
      try{
        const wei = ethers.utils.parseEther(ethAmt.toString());
        if(isFarcasterFrame){
          await provider.request({ method:'eth_sendTransaction', params:[{ from:userAddress, to:CONTRACT_ADDRESS, value:wei.toHexString() }]});
          showSuccess('Tx sent!');
        }else{
          const tx = await contract.buyTokens({ value:wei });
          await tx.wait();
          showSuccess('Success!');
        }
      }catch(e){ showError(e.code===4001?'Tx cancelled':'Tx failed'); }
    }

    /* ------------- PRESALE INFO ------------- */
    async function loadPresaleInfo(){
      try{
        let sold=0,total=1000e6;
        if(!isFarcasterFrame && ethersProvider){
          const read=new ethers.Contract(CONTRACT_ADDRESS,CONTRACT_ABI,ethersProvider);
          const info=await read.getInfo(); sold=parseFloat(ethers.utils.formatUnits(info.sold,18)); total=sold+parseFloat(ethers.utils.formatUnits(info.remaining,18));
        }
        $('tokens-sold').textContent=`${(sold/1e6).toFixed(0)}M / ${(total/1e6).toFixed(0)}M`;
      }catch{ $('tokens-sold').textContent='0M / 1000M'; }
    }

    /* ------------- AMOUNT INPUT ------------- */
    function setAmount(a){ $('amount-input').value=a; updateDisplay(); }
    window.setAmount=setAmount;
    function updateDisplay(){
      const a=parseFloat($('amount-input').value)||0; $('token-preview').innerHTML=a?`You will receive: <strong>${a*100}M FARC</strong>`:'Enter amount to see tokens';
      document.querySelectorAll('.button-amount').forEach(b=> b.classList.toggle('active',parseFloat(b.dataset.amount)==a));
    }

    /* ------------- SHARE ------------- */
    window.shareToken=async function(){
      const text='ðŸš€ Just bought $FARC tokens!';
      if(isFarcasterFrame&&window.sdk){ await sdk.actions.openUrl({ url:`https://farcaster.xyz/~/compose?text=${encodeURIComponent(text)}&embeds[]=https://farcaster.xyz/miniapps/zp8WXCloRpka/farc-token`}); }
      else if(navigator.share){ try{ await navigator.share({ title:'$FARC', text }); }catch{ navigator.clipboard.writeText(text); }}
      else navigator.clipboard.writeText(text);
    };

    /* ------------- STARTUP ------------- */
    window.addEventListener('DOMContentLoaded',async()=>{
      $('amount-input').addEventListener('input',()=>{ clearMsg(); updateDisplay(); });
      await initWallet();
      showApp();
    });
  </script>
</body>
</html>
