<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$FARC - The Farcaster Token</title>
    <link rel="icon" type="image/png" href="/farc.png">
    <link rel="manifest" href="/farcaster.json">
    
    <!-- Farcaster Mini App Meta -->
    <meta name="fc:frame" content="vNext">
    <meta name="fc:frame:image" content="https://farc.vercel.app/farc.png">
    <meta name="fc:frame:button:1" content="Launch App">
    <meta name="fc:frame:button:1:action" content="launch_frame">
    <meta name="fc:frame:button:1:target" content="https://farc.vercel.app">
    
    <!-- Add ethers.js -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            width: 120px;
            height: 120px;
            border-radius: 20px;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .button-primary {
            background: #10b981;
            color: white;
        }
        
        .button-primary:hover {
            background: #059669;
        }
        
        .button-primary:disabled {
            background: #6b7280;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .button-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            margin-top: 10px;
        }
        
        .button-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .button-amount {
            padding: 10px;
            font-size: 14px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.4);
        }
        
        .button-amount:hover {
            background: rgba(139, 92, 246, 0.3);
        }
        
        .button-amount.active {
            background: rgba(139, 92, 246, 0.5);
            border-color: #8B5CF6;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .hidden {
            display: none;
        }
        
        .wallet-info {
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
            opacity: 0.8;
        }
        
        .wallet-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.4);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            text-align: center;
        }
        
        input[type="number"]::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            text-align: center;
        }
        
        .success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            text-align: center;
        }
        
        .help-box {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 12px;
            text-align: center;
        }
        
        .help-box a {
            color: #10b981;
            text-decoration: none;
        }
        
        .social-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }
        
        .leaderboard-rank {
            font-size: 18px;
            font-weight: bold;
            width: 30px;
        }
        
        .leaderboard-user {
            flex: 1;
            margin: 0 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .leaderboard-amount {
            font-weight: bold;
            color: #10b981;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            <h2>Loading $FARC...</h2>
        </div>
        
        <div id="app" class="hidden">
            <div class="header">
                <img src="/farc.png" alt="FARC Logo" class="logo">
                <h1>$FARC</h1>
                <p id="header-text">The Official Farcaster Token</p>
                <p style="font-size: 14px; opacity: 0.8; margin-top: 5px;">üü£ Farcaster Exclusive</p>
                
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                    <a href="https://twitter.com/farctoken" target="_blank" class="social-link" style="display: inline-flex; align-items: center; gap: 5px; padding: 8px 16px; background: rgba(29, 161, 242, 0.1); border: 1px solid rgba(29, 161, 242, 0.3); border-radius: 20px; color: #1DA1F2; text-decoration: none; font-size: 14px; transition: all 0.3s;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                        </svg>
                        Twitter
                    </a>
                    <a href="https://warpcast.com/~/channel/farc" target="_blank" class="social-link" style="display: inline-flex; align-items: center; gap: 5px; padding: 8px 16px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 20px; color: #8B5CF6; text-decoration: none; font-size: 14px; transition: all 0.3s;">
                        üü£ Farcaster
                    </a>
                </div>
            </div>
            
            <div class="card">
                <h2>üî• Presale LIVE</h2>
                <div class="info-row">
                    <span>Network:</span>
                    <strong>Base (Chain ID: 8453)</strong>
                </div>
                <div class="info-row">
                    <span>Price:</span>
                    <strong>0.01 ETH = 1M FARC</strong>
                </div>
                <div class="info-row">
                    <span>Max per wallet:</span>
                    <strong>5M FARC</strong>
                </div>
                <div class="info-row">
                    <span>Sold:</span>
                    <strong id="tokens-sold">Loading...</strong>
                </div>
            </div>
            
            <div class="card">
                <h3>Buy $FARC</h3>
                
                <div id="message-area"></div>
                
                <div style="margin: 15px 0;">
                    <label style="font-size: 14px; opacity: 0.8;">Quick amounts or enter custom:</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 10px 0;">
                        <button onclick="window.setAmount(0.001)" class="button button-amount" data-amount="0.001">
                            0.001 ETH<br><small>0.1M FARC</small>
                        </button>
                        <button onclick="window.setAmount(0.01)" class="button button-amount active" data-amount="0.01">
                            0.01 ETH<br><small>1M FARC</small>
                        </button>
                        <button onclick="window.setAmount(0.05)" class="button button-amount" data-amount="0.05">
                            0.05 ETH<br><small>5M FARC</small>
                        </button>
                    </div>
                </div>
                
                <input 
                    type="number" 
                    id="amount-input" 
                    placeholder="Amount in ETH (e.g. 0.015)"
                    step="0.001"
                    min="0.001"
                    max="0.05"
                    value="0.01"
                >
                
                <div style="text-align: center; margin: 10px 0; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                    <span id="token-preview" style="font-size: 14px; color: #10b981;">
                        You will receive: <strong>1M FARC</strong>
                    </span>
                </div>
                
                <div id="wallet-info" class="wallet-info"></div>
                
                <button id="action-button" class="button button-primary">
                    Loading...
                </button>
                
                <button class="button button-secondary" onclick="window.shareToken()" style="position: relative;">
                    <span id="share-button-text">Share $FARC üì¢</span>
                    <span style="font-size: 10px; opacity: 0.7; display: block;">Cast on Farcaster</span>
                </button>
                
                <div class="help-box">
                    <p style="margin: 8px 0; font-size: 13px;">
                        üåê Visit <a href="https://farc.vercel.app" target="_blank" style="color: #10b981; font-weight: bold;">farc.vercel.app</a> for web version
                    </p>
                    <p style="margin: 8px 0; font-size: 12px; opacity: 0.9;">
                        üíß All proceeds will be added to liquidity pool
                    </p>
                    <p style="margin: 5px 0; font-size: 11px; opacity: 0.7;">
                        Contract: 0xdc73...fbdc
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Remove Eruda for production -->
    
    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = '0xdc73ad5d961d32703db3c61b4294ac5b584bfbdc';
        const CONTRACT_ABI = [
            'function buyTokens() external payable',
            'function getInfo() view returns (bool isActive, uint256 sold, uint256 remaining, uint256 pricePerMillion)',
            'function getRemainingAllocation(address) view returns (uint256)',
            'function purchasedAmount(address) view returns (uint256)',
            'function getLeaderboard() view returns (address[] buyers, uint256[] amounts)'
        ];
        
        // Global state
        let provider = null;
        let ethersProvider = null;
        let ethersSigner = null;
        let contract = null;
        let userAddress = null;
        let isConnected = false;
        let isFarcasterFrame = false;
        let sdk = null;
        
        // Simple mobile check
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        // Check if we're in Farcaster frame - simplified
        function checkEnvironment() {
            return new Promise(function(resolve) {
                try {
                    // Check if we're in an iframe
                    const inIframe = window !== window.parent;
                    
                    if (inIframe && !isMobile) {
                        // Desktop iframe - might be Farcaster
                        isFarcasterFrame = true;
                        console.log('Environment: Possible Farcaster Frame');
                    } else {
                        isFarcasterFrame = false;
                        console.log('Environment: ' + (isMobile ? 'Mobile Web' : 'Desktop Web'));
                    }
                    
                    resolve(isFarcasterFrame);
                } catch (e) {
                    console.log('Environment check error:', e);
                    isFarcasterFrame = false;
                    resolve(false);
                }
            });
        }
        
        // Initialize app
        function init() {
            console.log('Initializing FARC app...');
            
            // First show the UI
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Then check environment
            checkEnvironment().then(function() {
                initializeWallet();
            }).catch(function(error) {
                console.error('Environment check failed:', error);
                initializeWallet();
            });
        }
        
        // Initialize wallet based on environment - simplified for mobile
        function initializeWallet() {
            try {
                if (isMobile && !isFarcasterFrame) {
                    // Mobile web - show Warpcast option only
                    console.log('Mobile detected - Warpcast only mode');
                    showMobileMessage();
                    
                    // Still try to load leaderboard
                    setTimeout(function() {
                        // Create a read-only provider for Base network
                        try {
                            ethersProvider = new ethers.providers.JsonRpcProvider('https://mainnet.base.org');
                            loadPresaleInfo();
                            loadLeaderboard();
                        } catch (e) {
                            console.log('Failed to create read provider:', e);
                        }
                    }, 1000);
                    
                    return;
                }
                
                // Desktop or Farcaster Frame
                if (typeof window.ethereum !== 'undefined' && !isFarcasterFrame) {
                    // Desktop with MetaMask
                    provider = window.ethereum;
                    ethersProvider = new ethers.providers.Web3Provider(provider);
                    console.log('MetaMask detected');
                    updateUIForDisconnected();
                    
                    // Check existing connection
                    provider.request({ method: 'eth_accounts' })
                        .then(function(accounts) {
                            if (accounts && accounts.length > 0) {
                                handleConnection(accounts[0]);
                            }
                        })
                        .catch(function(e) {
                            console.log('No accounts:', e);
                        });
                        
                    // Listen for changes
                    if (provider.on) {
                        provider.on('accountsChanged', handleAccountsChanged);
                        provider.on('chainChanged', function() { window.location.reload(); });
                    }
                    
                } else if (isFarcasterFrame) {
                    // Try Farcaster SDK later
                    console.log('Farcaster Frame mode - SDK will be loaded');
                    showError('Loading Farcaster wallet...');
                    
                    // Try to load SDK after delay
                    setTimeout(function() {
                        loadFarcasterSDK();
                    }, 1000);
                    
                } else {
                    // No wallet
                    showError('Please install MetaMask or use Warpcast');
                    disableActions();
                }
                
                // Load data
                setTimeout(function() {
                    if (ethersProvider) {
                        loadPresaleInfo();
                        loadLeaderboard();
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Wallet init error:', error);
                showError('Initialization error');
            }
        }
        
        // Handle account changes
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                isConnected = false;
                userAddress = null;
                updateUIForDisconnected();
            } else if (accounts[0] !== userAddress) {
                handleConnection(accounts[0]);
            }
        }
        
        // Handle connection
        async function handleConnection(address) {
            userAddress = address;
            isConnected = true;
            
            // Create ethers objects for web browsers
            if (!isFarcasterFrame && provider) {
                if (!ethersProvider) {
                    ethersProvider = new ethers.providers.Web3Provider(provider);
                }
                ethersSigner = ethersProvider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, ethersSigner);
                
                // Check network
                const network = await ethersProvider.getNetwork();
                if (network.chainId !== 8453) {
                    showError('Please switch to Base network (Chain ID: 8453)');
                    try {
                        await provider.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x2105' }] // 8453 in hex
                        });
                    } catch (switchError) {
                        console.error('Failed to switch network:', switchError);
                    }
                }
            }
            
            updateUIForConnected();
            clearMessage();
            
            // Load presale info after connection
            loadPresaleInfo();
        }
        
        // Update UI for connected state
        function updateUIForConnected() {
            const walletInfo = document.getElementById('wallet-info');
            walletInfo.innerHTML = `
                <div class="wallet-badge">
                    <span>üü£</span>
                    <span>${userAddress.slice(0, 6)}...${userAddress.slice(-4)}</span>
                </div>
            `;
            
            const button = document.getElementById('action-button');
            button.textContent = 'Buy FARC üöÄ';
            button.onclick = buyTokens;
            button.disabled = false;
        }
        
        // Show mobile message
        function showMobileMessage() {
            const walletInfo = document.getElementById('wallet-info');
            walletInfo.innerHTML = '';
            
            const button = document.getElementById('action-button');
            button.textContent = 'Open in Warpcast üü£';
            button.onclick = function() {
                // Deep link to Warpcast
                const warpcastUrl = 'https://warpcast.com/~/add-cast-action?url=' + encodeURIComponent('https://farc.vercel.app');
                window.location.href = warpcastUrl;
            };
            button.disabled = false;
            
            showError('üì± Mobile users: Please open this app in Warpcast to connect your Farcaster wallet');
        }
        
        // Update UI for disconnected state
        function updateUIForDisconnected() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile && !isFarcasterFrame) {
                showMobileMessage();
                return;
            }
            
            const walletInfo = document.getElementById('wallet-info');
            walletInfo.innerHTML = '';
            
            const button = document.getElementById('action-button');
            button.textContent = 'Connect Wallet';
            button.onclick = connectWallet;
            button.disabled = false;
        }
        
        // Disable actions
        function disableActions() {
            const button = document.getElementById('action-button');
            button.disabled = true;
            button.textContent = 'Wallet Not Available';
        }
        
        // Connect wallet
        async function connectWallet() {
            try {
                clearMessage();
                const button = document.getElementById('action-button');
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                
                if (isMobile && !isFarcasterFrame) {
                    // Mobile - redirect to Warpcast
                    const warpcastUrl = 'https://warpcast.com/~/add-cast-action?url=' + encodeURIComponent('https://farc.vercel.app');
                    window.location.href = warpcastUrl;
                    return;
                }
                
                button.textContent = 'Connecting...';
                button.disabled = true;
                
                const accounts = await provider.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                if (accounts && accounts.length > 0) {
                    await handleConnection(accounts[0]);
                } else {
                    showError('No accounts found');
                    updateUIForDisconnected();
                }
                
            } catch (error) {
                console.error('Connect error:', error);
                if (error.code === 4001) {
                    showError('Connection cancelled');
                } else {
                    showError('Failed to connect wallet');
                }
                updateUIForDisconnected();
            }
        }
        
        // Buy tokens
        async function buyTokens() {
            const amount = document.getElementById('amount-input').value;
            
            if (!amount || parseFloat(amount) <= 0) {
                showError('Please select an amount');
                return;
            }
            
            try {
                clearMessage();
                const button = document.getElementById('action-button');
                button.textContent = 'Processing...';
                button.disabled = true;
                
                const ethAmount = parseFloat(amount);
                const tokensToReceive = ethAmount * 100;
                
                console.log('Sending transaction...');
                console.log('Amount:', ethAmount, 'ETH');
                console.log('Environment:', isFarcasterFrame ? 'Farcaster' : 'Web');
                
                if (isFarcasterFrame) {
                    // Farcaster Frame - Simple ETH transfer (no data field!)
                    console.log('Using Farcaster simple ETH transfer...');
                    
                    const weiValue = Math.floor(ethAmount * 1e18);
                    const hexValue = '0x' + weiValue.toString(16);
                    
                    // ETH TRANSFER with from address for Farcaster
                    const transaction = {
                        from: userAddress.toLowerCase(), // Farcaster needs this
                        to: CONTRACT_ADDRESS.toLowerCase(),
                        value: hexValue
                        // NO data field - just ETH!
                    };
                    
                    console.log('Farcaster ETH transfer:', transaction);
                    
                    try {
                        const txHash = await provider.request({
                            method: 'eth_sendTransaction',
                            params: [transaction]
                        });
                        
                        console.log('Success! Transaction sent:', txHash);
                        
                        // Show success with share prompt
                        showSuccess(
                            `‚úÖ Transaction sent!\n` +
                            `You will receive: ${tokensToReceive}M FARC\n` +
                            `Tx: ${txHash.slice(0, 10)}...${txHash.slice(-8)}`
                        );
                        
                        // Prompt to share after successful purchase
                        setTimeout(() => {
                            if (confirm('üéâ Congrats! Share your FARC purchase on Farcaster?')) {
                                window.shareToken();
                            }
                        }, 2000);
                        
                        setTimeout(() => {
                            loadPresaleInfo();
                            loadLeaderboard(); // Refresh leaderboard after purchase
                        }, 5000);
                        
                    } catch (txError) {
                        console.error('Farcaster transaction failed:', txError);
                        
                        if (txError.code === 4001) {
                            showError('Transaction cancelled');
                        } else {
                            showError('Transaction failed. Please try again.');
                        }
                    }
                    
                } else {
                    // Web browser transaction (MetaMask, etc.)
                    console.log('Using ethers.js transaction method...');
                    
                    if (!contract) {
                        showError('Contract not initialized. Please reconnect wallet.');
                        return;
                    }
                    
                    const tx = await contract.buyTokens({
                        value: ethers.utils.parseEther(amount.toString())
                    });
                    
                    console.log('Transaction sent:', tx.hash);
                    showSuccess(`Transaction sent! Hash: ${tx.hash.slice(0, 10)}...`);
                    
                    // Wait for confirmation
                    button.textContent = 'Confirming...';
                    const receipt = await tx.wait();
                    
                    console.log('Transaction confirmed:', receipt);
                    
                    showSuccess(
                        `‚úÖ Success! You bought ${tokensToReceive}M FARC\n` +
                        `Tx: ${tx.hash.slice(0, 10)}...${tx.hash.slice(-8)}`
                    );
                    
                    // Prompt to share for web users too
                    setTimeout(() => {
                        if (confirm('üéâ Congrats! Share your FARC purchase?')) {
                            window.shareToken();
                        }
                    }, 1000);
                    
                    setTimeout(() => {
                        loadPresaleInfo();
                        loadLeaderboard(); // Refresh leaderboard
                    }, 3000);
                }
                
            } catch (error) {
                console.error('Transaction error:', error);
                
                if (error.code === 'ACTION_REJECTED' || error.code === 4001) {
                    showError('Transaction cancelled');
                } else if (error.code === 'INSUFFICIENT_FUNDS' || error.message?.includes('insufficient funds')) {
                    showError('Insufficient ETH balance');
                } else if (error.message?.includes('UnsupportedMethodError')) {
                    showError(
                        'Wallet compatibility issue. Please try:\n' +
                        '‚Ä¢ Buy directly on BaseScan (link below)\n' +
                        '‚Ä¢ Use the web version at farc.vercel.app'
                    );
                } else if (error.reason) {
                    showError(`Failed: ${error.reason}`);
                } else {
                    showError('Transaction failed. Try alternative methods below.');
                }
            } finally {
                updateUIForConnected();
            }
        }
        
        // Load presale info
        async function loadPresaleInfo() {
            try {
                if (isFarcasterFrame && provider) {
                    // Try Farcaster with new contract's getInfo function
                    try {
                        const data = '0x5a9b0826'; // getInfo() selector
                        const result = await provider.request({
                            method: 'eth_call',
                            params: [{
                                to: CONTRACT_ADDRESS,
                                data: data
                            }, 'latest']
                        });
                        
                        if (result && result !== '0x') {
                            // Decode getInfo return values
                            const sold = parseInt(result.slice(130, 194), 16) / 1e18;
                            const remaining = parseInt(result.slice(194, 258), 16) / 1e18;
                            const total = sold + remaining;
                            
                            document.getElementById('tokens-sold').textContent = 
                                `${(sold / 1e6).toFixed(0)}M / ${(total / 1e6).toFixed(0)}M`;
                        }
                    } catch (e) {
                        console.log('Farcaster call failed, using static:', e);
                        document.getElementById('tokens-sold').textContent = '0M / 1000M';
                    }
                } else if (ethersProvider) {
                    // Web browser - use ethers
                    const readContract = new ethers.Contract(
                        CONTRACT_ADDRESS, 
                        CONTRACT_ABI, 
                        ethersProvider
                    );
                    
                    const info = await readContract.getInfo();
                    const sold = parseFloat(ethers.utils.formatUnits(info.sold, 18));
                    const remaining = parseFloat(ethers.utils.formatUnits(info.remaining, 18));
                    const total = sold + remaining;
                    
                    document.getElementById('tokens-sold').textContent = 
                        `${(sold / 1e6).toFixed(0)}M / ${(total / 1e6).toFixed(0)}M`;
                } else {
                    // Fallback
                    document.getElementById('tokens-sold').textContent = '0M / 1000M';
                }
                    
            } catch (error) {
                console.error('Error loading presale info:', error);
                document.getElementById('tokens-sold').textContent = '0M / 1000M';
            }
        }
        
        // Message functions
        function showError(message) {
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = `<div class="error">${message}</div>`;
        }
        
        function showSuccess(message) {
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = `<div class="success">${message}</div>`;
        }
        
        function clearMessage() {
            document.getElementById('message-area').innerHTML = '';
        }
        
        // Helper functions
        window.setAmount = function(amount) {
            document.getElementById('amount-input').value = amount;
            
            // Update active button
            document.querySelectorAll('.button-amount').forEach(btn => {
                if (btn.getAttribute('data-amount') === amount.toString()) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            clearMessage();
            updateTokenDisplay();
        }
        
        // Update token display when amount changes
        function updateTokenDisplay() {
            const amountInput = document.getElementById('amount-input');
            const amount = parseFloat(amountInput.value) || 0;
            const tokens = amount * 100; // 100M per ETH
            
            // Update preview
            const preview = document.getElementById('token-preview');
            if (preview) {
                if (amount > 0) {
                    preview.innerHTML = `You will receive: <strong>${tokens}M FARC</strong>`;
                } else {
                    preview.innerHTML = `Enter amount to see tokens`;
                }
            }
            
            if (amount > 0) {
                // Update quick amount buttons to show if it matches
                document.querySelectorAll('.button-amount').forEach(btn => {
                    const btnAmount = parseFloat(btn.getAttribute('data-amount'));
                    if (Math.abs(btnAmount - amount) < 0.0001) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }
        }
        
        // Add event listener for input changes
        window.addEventListener('DOMContentLoaded', function() {
            const amountInput = document.getElementById('amount-input');
            if (amountInput) {
                amountInput.addEventListener('input', updateTokenDisplay);
            }
        });
        
        window.shareToken = async function() {
            try {
                if (isFarcasterFrame && sdk) {
                    // Farcaster native sharing
                    console.log('Using Farcaster native share...');
                    
                    // Create share intent
                    const shareUrl = `https://warpcast.com/~/compose?text=${encodeURIComponent(
                        'üöÄ Just bought $FARC tokens!\n\n' +
                        'The Official Farcaster Token\n' +
                        'üíú Presale: 0.01 ETH = 1M FARC\n' +
                        'üî• Max 5M per wallet\n\n' +
                        'Get yours now! üëá'
                    )}&embeds[]=${encodeURIComponent('https://farc.vercel.app')}`;
                    
                    // Try to open share dialog
                    if (sdk.actions?.openUrl) {
                        await sdk.actions.openUrl({ url: shareUrl });
                    } else {
                        // Fallback to clipboard
                        copyShareText();
                    }
                } else {
                    // Web browser sharing
                    const text = 'Check out $FARC - The Official Farcaster Token! üöÄ\n\nPresale: 0.01 ETH = 1M FARC\nMax 5M per wallet\n\nüü£ Farcaster exclusive\n\nhttps://farc.vercel.app';
                    
                    if (navigator.share) {
                        navigator.share({
                            title: '$FARC Token',
                            text: text
                        }).catch(() => {
                            copyToClipboard(text);
                        });
                    } else {
                        copyToClipboard(text);
                    }
                }
            } catch (error) {
                console.error('Share error:', error);
                copyShareText();
            }
        }
        
        function copyShareText() {
            const text = 'üöÄ Just bought $FARC tokens!\n\nThe Official Farcaster Token\nüíú Presale: 0.01 ETH = 1M FARC\nüî• Max 5M per wallet\n\nGet yours: https://farc.vercel.app';
            copyToClipboard(text);
        }
        
        // Load Farcaster SDK separately
        
       async function loadFarcasterSDK() {
    try {
        const module = await import('https://esm.sh/@farcaster/frame-sdk');
        sdk = module.sdk;

        await sdk.actions.ready();
        console.log('‚úÖ Farcaster SDK ready');

        if (sdk?.wallet?.ethProvider && typeof sdk.wallet.ethProvider.request === 'function') {
            provider = sdk.wallet.ethProvider;
            console.log('‚úÖ Farcaster Provider connected:', provider);
        } else {
            throw new Error('‚ùå Farcaster provider not available or invalid');
        }

    } catch (error) {
        console.error('Farcaster SDK load error:', error);
        setDebugError(error);
        showError('Farcaster wallet unavailable');
    }
}

                    // Check connection
                    const accounts = await provider.request({ method: 'eth_accounts' });
                    if (accounts && accounts.length > 0) {
                        await handleConnection(accounts[0]);
                    } else {
                        updateUIForDisconnected();
                    }
                } else {
                    showError('Farcaster wallet not available');
                    disableActions();
                }
            } catch (e) {
                console.error('Farcaster SDK error:', e);
                showError('Failed to load Farcaster wallet');
                disableActions();
            }
        }
        async function loadLeaderboard() {
            try {
                let leaderboardData = [];
                
                if (ethersProvider) {
                    // Load from contract
                    const readContract = new ethers.Contract(
                        CONTRACT_ADDRESS, 
                        CONTRACT_ABI, 
                        ethersProvider
                    );
                    
                    try {
                        const result = await readContract.getLeaderboard();
                        const buyers = result[0] || result.buyers || [];
                        const amounts = result[1] || result.amounts || [];
                        
                        // Combine and sort
                        leaderboardData = buyers.map(function(buyer, i) {
                            return {
                                address: buyer,
                                amount: parseFloat(ethers.utils.formatUnits(amounts[i], 18))
                            };
                        }).filter(function(item) {
                            return item.amount > 0;
                        }).sort(function(a, b) {
                            return b.amount - a.amount;
                        }).slice(0, 5); // Top 5
                        
                    } catch (contractError) {
                        console.error('Contract call error:', contractError);
                    }
                }
                
                // Display leaderboard
                const leaderboardEl = document.getElementById('leaderboard');
                if (!leaderboardEl) return;
                
                if (leaderboardData.length === 0) {
                    leaderboardEl.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.7;">Be the first to buy FARC! üöÄ</div>';
                } else {
                    let html = '';
                    for (let i = 0; i < leaderboardData.length; i++) {
                        const item = leaderboardData[i];
                        const rank = i + 1;
                        const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '#' + rank;
                        const shortAddress = item.address.slice(0, 6) + '...' + item.address.slice(-4);
                        const amount = (item.amount / 1e6).toFixed(2);
                        
                        html += '<div class="leaderboard-item">' +
                            '<div class="leaderboard-rank">' + medal + '</div>' +
                            '<div class="leaderboard-user">' +
                            '<span>' + shortAddress + '</span>' +
                            (isFarcasterFrame ? '<span style="opacity: 0.7; font-size: 12px;">@farcaster</span>' : '') +
                            '</div>' +
                            '<div class="leaderboard-amount">' + amount + 'M FARC</div>' +
                            '</div>';
                    }
                    leaderboardEl.innerHTML = html;
                }
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                const leaderboardEl = document.getElementById('leaderboard');
                if (leaderboardEl) {
                    leaderboardEl.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.7;">Leaderboard unavailable</div>';
                }
            }
        }
        
        // Start app
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
