<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$FARC - The Farcaster Token</title>
    <link rel="icon" type="image/png" href="/farc.png">
    <link rel="manifest" href="/farcaster.json">
    
    <!-- Farcaster Mini App Meta -->
    <meta name="fc:frame" content="vNext">
    <meta name="fc:frame:image" content="https://farc.vercel.app/farc.png">
    <meta name="fc:frame:button:1" content="Launch App">
    <meta name="fc:frame:button:1:action" content="launch_frame">
    <meta name="fc:frame:button:1:target" content="https://farc.vercel.app">
    
    <!-- Add ethers.js -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            width: 120px;
            height: 120px;
            border-radius: 20px;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .button-primary {
            background: #10b981;
            color: white;
        }
        
        .button-primary:hover {
            background: #059669;
        }
        
        .button-primary:disabled {
            background: #6b7280;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .button-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            margin-top: 10px;
        }
        
        .button-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .button-amount {
            padding: 10px;
            font-size: 14px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.4);
        }
        
        .button-amount:hover {
            background: rgba(139, 92, 246, 0.3);
        }
        
        .button-amount.active {
            background: rgba(139, 92, 246, 0.5);
            border-color: #8B5CF6;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .hidden {
            display: none;
        }
        
        .wallet-info {
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
            opacity: 0.8;
        }
        
        .wallet-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.4);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            text-align: center;
        }
        
        input[type="number"]::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            text-align: center;
        }
        
        .success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            text-align: center;
        }
        
        .help-box {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 12px;
            text-align: center;
        }
        
        .help-box a {
            color: #10b981;
            text-decoration: none;
        }
        
        .social-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }
        
        .leaderboard-rank {
            font-size: 18px;
            font-weight: bold;
            width: 30px;
        }
        
        .leaderboard-user {
            flex: 1;
            margin: 0 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .leaderboard-amount {
            font-weight: bold;
            color: #10b981;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            <h2>Loading $FARC...</h2>
        </div>
        
        <div id="app" class="hidden">
            <div class="header">
                <img src="/farc.png" alt="FARC Logo" class="logo">
                <h1>$FARC</h1>
                <p id="header-text">The Official Farcaster Token</p>
                <p style="font-size: 14px; opacity: 0.8; margin-top: 5px;">üü£ Farcaster Exclusive</p>
                
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                    <a href="https://twitter.com/farctoken" target="_blank" class="social-link" style="display: inline-flex; align-items: center; gap: 5px; padding: 8px 16px; background: rgba(29, 161, 242, 0.1); border: 1px solid rgba(29, 161, 242, 0.3); border-radius: 20px; color: #1DA1F2; text-decoration: none; font-size: 14px; transition: all 0.3s;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                        </svg>
                        Twitter
                    </a>
                    <a href="https://warpcast.com/~/channel/farc" target="_blank" class="social-link" style="display: inline-flex; align-items: center; gap: 5px; padding: 8px 16px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 20px; color: #8B5CF6; text-decoration: none; font-size: 14px; transition: all 0.3s;">
                        üü£ Farcaster
                    </a>
                </div>
            </div>
            
            <div class="card">
                <h2>üî• Presale LIVE</h2>
                <div class="info-row">
                    <span>Network:</span>
                    <strong>Base (Chain ID: 8453)</strong>
                </div>
                <div class="info-row">
                    <span>Price:</span>
                    <strong>0.01 ETH = 1M FARC</strong>
                </div>
                <div class="info-row">
                    <span>Max per wallet:</span>
                    <strong>5M FARC</strong>
                </div>
                <div class="info-row">
                    <span>Sold:</span>
                    <strong id="tokens-sold">Loading...</strong>
                </div>
            </div>
            
            <div class="card">
                <h3>Buy $FARC</h3>
                
                <div id="message-area"></div>
                
                <div style="margin: 15px 0;">
                    <label style="font-size: 14px; opacity: 0.8;">Quick amounts or enter custom:</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 10px 0;">
                        <button onclick="window.setAmount(0.001)" class="button button-amount" data-amount="0.001">
                            0.001 ETH<br><small>0.1M FARC</small>
                        </button>
                        <button onclick="window.setAmount(0.01)" class="button button-amount active" data-amount="0.01">
                            0.01 ETH<br><small>1M FARC</small>
                        </button>
                        <button onclick="window.setAmount(0.05)" class="button button-amount" data-amount="0.05">
                            0.05 ETH<br><small>5M FARC</small>
                        </button>
                    </div>
                </div>
                
                <input 
                    type="number" 
                    id="amount-input" 
                    placeholder="Amount in ETH (e.g. 0.015)"
                    step="0.001"
                    min="0.001"
                    max="0.05"
                    value="0.01"
                >
                
                <div style="text-align: center; margin: 10px 0; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                    <span id="token-preview" style="font-size: 14px; color: #10b981;">
                        You will receive: <strong>1M FARC</strong>
                    </span>
                </div>
                
                <div id="wallet-info" class="wallet-info"></div>
                
                <button id="action-button" class="button button-primary">
                    Loading...
                </button>
                
                <button class="button button-secondary" onclick="window.shareToken()" style="position: relative;">
                    <span id="share-button-text">Share $FARC üì¢</span>
                    <span style="font-size: 10px; opacity: 0.7; display: block;">Cast on Farcaster</span>
                </button>
                
                <div class="help-box">
                    <p style="margin: 8px 0; font-size: 13px;">
                        üåê Visit <a href="https://farc.vercel.app" target="_blank" style="color: #10b981; font-weight: bold;">farc.vercel.app</a> for web version
                    </p>
                    <p style="margin: 8px 0; font-size: 12px; opacity: 0.9;">
                        üíß All proceeds will be added to liquidity pool
                    </p>
                    <p style="margin: 5px 0; font-size: 11px; opacity: 0.7;">
                        Contract: 0xdc73...fbdc
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add mobile console for debugging -->
    <script>
        // Add Eruda console for mobile debugging (remove in production)
        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
            var script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/eruda@3/eruda.min.js';
            document.body.appendChild(script);
            script.onload = function() {
                eruda.init();
                console.log('Mobile console activated');
            };
        }
    </script>
    
    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = '0xdc73ad5d961d32703db3c61b4294ac5b584bfbdc';
        const CONTRACT_ABI = [
            'function buyTokens() external payable',
            'function getInfo() view returns (bool isActive, uint256 sold, uint256 remaining, uint256 pricePerMillion)',
            'function getRemainingAllocation(address) view returns (uint256)',
            'function purchasedAmount(address) view returns (uint256)',
            'function getLeaderboard() view returns (address[] buyers, uint256[] amounts)'
        ];
        
        // Global state
        let provider = null;
        let ethersProvider = null;
        let ethersSigner = null;
        let contract = null;
        let userAddress = null;
        let isConnected = false;
        let isFarcasterFrame = false;
        let sdk = null;
        
        // Mobile error display
        window.addEventListener('error', function(e) {
            console.error('Global error:', e);
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position:fixed;bottom:0;left:0;right:0;background:red;color:white;padding:10px;z-index:9999;font-size:12px;';
                errorDiv.textContent = 'Error: ' + e.message + ' at ' + e.filename + ':' + e.lineno;
                document.body.appendChild(errorDiv);
                setTimeout(function() {
                    errorDiv.remove();
                }, 10000);
            }
        });
        
        // Check if we're in Farcaster frame
        async function checkEnvironment() {
            try {
                // Check if we're in an iframe
                const inIframe = window !== window.parent;
                
                if (inIframe) {
                    // Try to load Farcaster SDK dynamically
                    const script = document.createElement('script');
                    script.type = 'module';
                    
                    return new Promise(function(resolve) {
                        script.onload = async function() {
                            try {
                                const module = await import('https://esm.sh/@farcaster/frame-sdk');
                                sdk = module.sdk;
                                isFarcasterFrame = true;
                                console.log('Environment: Farcaster Frame');
                                resolve(true);
                            } catch (e) {
                                console.log('Failed to load Farcaster SDK:', e);
                                isFarcasterFrame = false;
                                resolve(false);
                            }
                        };
                        
                        script.onerror = function() {
                            console.log('Environment: Web Browser (SDK load failed)');
                            isFarcasterFrame = false;
                            resolve(false);
                        };
                        
                        script.src = 'https://esm.sh/@farcaster/frame-sdk';
                        document.head.appendChild(script);
                    });
                }
                
                console.log('Environment: Web Browser');
                isFarcasterFrame = false;
                return false;
                
            } catch (error) {
                console.log('Environment check error:', error);
                isFarcasterFrame = false;
                return false;
            }
        }
        
        // Initialize app
        function init() {
            console.log('Initializing FARC app...');
            
            // First show the UI
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Then check environment
            checkEnvironment().then(function() {
                initializeWallet();
            }).catch(function(error) {
                console.error('Environment check failed:', error);
                initializeWallet();
            });
        }
        
        // Initialize wallet based on environment
        async function initializeWallet() {
            try {
                if (isFarcasterFrame && sdk) {
                    // Farcaster Frame initialization
                    try {
                        await sdk.actions.ready();
                        console.log('Farcaster SDK ready');
                        
                        provider = sdk.wallet?.ethProvider;
                        
                        if (!provider) {
                            console.log('No wallet provider in SDK');
                            showError('Please open this app in Warpcast');
                            disableActions();
                            return;
                        }
                        
                        console.log('Farcaster Provider:', provider);
                    } catch (sdkError) {
                        console.error('SDK initialization error:', sdkError);
                        showError('Failed to initialize Farcaster SDK');
                        disableActions();
                        return;
                    }
                    
                } else {
                    // Regular web browser initialization
                    console.log('Web browser mode - checking for wallet...');
                    
                    if (typeof window.ethereum !== 'undefined') {
                        provider = window.ethereum;
                        ethersProvider = new ethers.providers.Web3Provider(provider);
                        console.log('MetaMask or Web3 wallet detected');
                        updateUIForDisconnected();
                    } else {
                        showError('Please install MetaMask or another Web3 wallet');
                        disableActions();
                        return;
                    }
                }
                
                // Check if already connected
                try {
                    const accounts = await provider.request({ method: 'eth_accounts' });
                    if (accounts && accounts.length > 0) {
                        await handleConnection(accounts[0]);
                    } else {
                        updateUIForDisconnected();
                    }
                } catch (error) {
                    console.log('No existing connection:', error);
                    updateUIForDisconnected();
                }
                
                // Listen for account changes
                if (provider && provider.on) {
                    provider.on('accountsChanged', handleAccountsChanged);
                    if (!isFarcasterFrame) {
                        provider.on('chainChanged', function() { window.location.reload(); });
                    }
                }
                
                // Load presale info
                if (!isFarcasterFrame) {
                    loadPresaleInfo();
                }
                
                // Load leaderboard after a delay
                setTimeout(function() {
                    loadLeaderboard();
                }, 2000);
                
            } catch (error) {
                console.error('Wallet init error:', error);
                showError('Initialization error. Please refresh.');
                updateUIForDisconnected();
            }
        }
        
        // Handle account changes
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                isConnected = false;
                userAddress = null;
                updateUIForDisconnected();
            } else if (accounts[0] !== userAddress) {
                handleConnection(accounts[0]);
            }
        }
        
        // Handle connection
        async function handleConnection(address) {
            userAddress = address;
            isConnected = true;
            
            // Create ethers objects for web browsers
            if (!isFarcasterFrame && provider) {
                if (!ethersProvider) {
                    ethersProvider = new ethers.providers.Web3Provider(provider);
                }
                ethersSigner = ethersProvider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, ethersSigner);
                
                // Check network
                const network = await ethersProvider.getNetwork();
                if (network.chainId !== 8453) {
                    showError('Please switch to Base network (Chain ID: 8453)');
                    try {
                        await provider.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x2105' }] // 8453 in hex
                        });
                    } catch (switchError) {
                        console.error('Failed to switch network:', switchError);
                    }
                }
            }
            
            updateUIForConnected();
            clearMessage();
            
            // Load presale info after connection
            loadPresaleInfo();
        }
        
        // Update UI for connected state
        function updateUIForConnected() {
            const walletInfo = document.getElementById('wallet-info');
            walletInfo.innerHTML = `
                <div class="wallet-badge">
                    <span>üü£</span>
                    <span>${userAddress.slice(0, 6)}...${userAddress.slice(-4)}</span>
                </div>
            `;
            
            const button = document.getElementById('action-button');
            button.textContent = 'Buy FARC üöÄ';
            button.onclick = buyTokens;
            button.disabled = false;
        }
        
        // Update UI for disconnected state
        function updateUIForDisconnected() {
            const walletInfo = document.getElementById('wallet-info');
            walletInfo.innerHTML = '';
            
            const button = document.getElementById('action-button');
            button.textContent = 'Connect Wallet';
            button.onclick = connectWallet;
            button.disabled = false;
        }
        
        // Disable actions
        function disableActions() {
            const button = document.getElementById('action-button');
            button.disabled = true;
            button.textContent = 'Wallet Not Available';
        }
        
        // Connect wallet
        async function connectWallet() {
            try {
                clearMessage();
                const button = document.getElementById('action-button');
                button.textContent = 'Connecting...';
                button.disabled = true;
                
                const accounts = await provider.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                if (accounts && accounts.length > 0) {
                    await handleConnection(accounts[0]);
                } else {
                    showError('No accounts found');
                    updateUIForDisconnected();
                }
                
            } catch (error) {
                console.error('Connect error:', error);
                if (error.code === 4001) {
                    showError('Connection cancelled');
                } else {
                    showError('Failed to connect wallet');
                }
                updateUIForDisconnected();
            }
        }
        
        // Buy tokens
        async function buyTokens() {
            const amount = document.getElementById('amount-input').value;
            
            if (!amount || parseFloat(amount) <= 0) {
                showError('Please select an amount');
                return;
            }
            
            try {
                clearMessage();
                const button = document.getElementById('action-button');
                button.textContent = 'Processing...';
                button.disabled = true;
                
                const ethAmount = parseFloat(amount);
                const tokensToReceive = ethAmount * 100;
                
                console.log('Sending transaction...');
                console.log('Amount:', ethAmount, 'ETH');
                console.log('Environment:', isFarcasterFrame ? 'Farcaster' : 'Web');
                
                if (isFarcasterFrame) {
                    // Farcaster Frame - Simple ETH transfer (no data field!)
                    console.log('Using Farcaster simple ETH transfer...');
                    
                    const weiValue = Math.floor(ethAmount * 1e18);
                    const hexValue = '0x' + weiValue.toString(16);
                    
                    // ETH TRANSFER with from address for Farcaster
                    const transaction = {
                        from: userAddress.toLowerCase(), // Farcaster needs this
                        to: CONTRACT_ADDRESS.toLowerCase(),
                        value: hexValue
                        // NO data field - just ETH!
                    };
                    
                    console.log('Farcaster ETH transfer:', transaction);
                    
                    try {
                        const txHash = await provider.request({
                            method: 'eth_sendTransaction',
                            params: [transaction]
                        });
                        
                        console.log('Success! Transaction sent:', txHash);
                        
                        // Show success with share prompt
                        showSuccess(
                            `‚úÖ Transaction sent!\n` +
                            `You will receive: ${tokensToReceive}M FARC\n` +
                            `Tx: ${txHash.slice(0, 10)}...${txHash.slice(-8)}`
                        );
                        
                        // Prompt to share after successful purchase
                        setTimeout(() => {
                            if (confirm('üéâ Congrats! Share your FARC purchase on Farcaster?')) {
                                window.shareToken();
                            }
                        }, 2000);
                        
                        setTimeout(() => {
                            loadPresaleInfo();
                            loadLeaderboard(); // Refresh leaderboard after purchase
                        }, 5000);
                        
                    } catch (txError) {
                        console.error('Farcaster transaction failed:', txError);
                        
                        if (txError.code === 4001) {
                            showError('Transaction cancelled');
                        } else {
                            showError('Transaction failed. Please try again.');
                        }
                    }
                    
                } else {
                    // Web browser transaction (MetaMask, etc.)
                    console.log('Using ethers.js transaction method...');
                    
                    if (!contract) {
                        showError('Contract not initialized. Please reconnect wallet.');
                        return;
                    }
                    
                    const tx = await contract.buyTokens({
                        value: ethers.utils.parseEther(amount.toString())
                    });
                    
                    console.log('Transaction sent:', tx.hash);
                    showSuccess(`Transaction sent! Hash: ${tx.hash.slice(0, 10)}...`);
                    
                    // Wait for confirmation
                    button.textContent = 'Confirming...';
                    const receipt = await tx.wait();
                    
                    console.log('Transaction confirmed:', receipt);
                    
                    showSuccess(
                        `‚úÖ Success! You bought ${tokensToReceive}M FARC\n` +
                        `Tx: ${tx.hash.slice(0, 10)}...${tx.hash.slice(-8)}`
                    );
                    
                    // Prompt to share for web users too
                    setTimeout(() => {
                        if (confirm('üéâ Congrats! Share your FARC purchase?')) {
                            window.shareToken();
                        }
                    }, 1000);
                    
                    setTimeout(() => {
                        loadPresaleInfo();
                        loadLeaderboard(); // Refresh leaderboard
                    }, 3000);
                }
                
            } catch (error) {
                console.error('Transaction error:', error);
                
                if (error.code === 'ACTION_REJECTED' || error.code === 4001) {
                    showError('Transaction cancelled');
                } else if (error.code === 'INSUFFICIENT_FUNDS' || error.message?.includes('insufficient funds')) {
                    showError('Insufficient ETH balance');
                } else if (error.message?.includes('UnsupportedMethodError')) {
                    showError(
                        'Wallet compatibility issue. Please try:\n' +
                        '‚Ä¢ Buy directly on BaseScan (link below)\n' +
                        '‚Ä¢ Use the web version at farc.vercel.app'
                    );
                } else if (error.reason) {
                    showError(`Failed: ${error.reason}`);
                } else {
                    showError('Transaction failed. Try alternative methods below.');
                }
            } finally {
                updateUIForConnected();
            }
        }
        
        // Load presale info
        async function loadPresaleInfo() {
            try {
                if (isFarcasterFrame && provider) {
                    // Try Farcaster with new contract's getInfo function
                    try {
                        const data = '0x5a9b0826'; // getInfo() selector
                        const result = await provider.request({
                            method: 'eth_call',
                            params: [{
                                to: CONTRACT_ADDRESS,
                                data: data
                            }, 'latest']
                        });
                        
                        if (result && result !== '0x') {
                            // Decode getInfo return values
                            const sold = parseInt(result.slice(130, 194), 16) / 1e18;
                            const remaining = parseInt(result.slice(194, 258), 16) / 1e18;
                            const total = sold + remaining;
                            
                            document.getElementById('tokens-sold').textContent = 
                                `${(sold / 1e6).toFixed(0)}M / ${(total / 1e6).toFixed(0)}M`;
                        }
                    } catch (e) {
                        console.log('Farcaster call failed, using static:', e);
                        document.getElementById('tokens-sold').textContent = '0M / 1000M';
                    }
                } else if (ethersProvider) {
                    // Web browser - use ethers
                    const readContract = new ethers.Contract(
                        CONTRACT_ADDRESS, 
                        CONTRACT_ABI, 
                        ethersProvider
                    );
                    
                    const info = await readContract.getInfo();
                    const sold = parseFloat(ethers.utils.formatUnits(info.sold, 18));
                    const remaining = parseFloat(ethers.utils.formatUnits(info.remaining, 18));
                    const total = sold + remaining;
                    
                    document.getElementById('tokens-sold').textContent = 
                        `${(sold / 1e6).toFixed(0)}M / ${(total / 1e6).toFixed(0)}M`;
                } else {
                    // Fallback
                    document.getElementById('tokens-sold').textContent = '0M / 1000M';
                }
                    
            } catch (error) {
                console.error('Error loading presale info:', error);
                document.getElementById('tokens-sold').textContent = '0M / 1000M';
            }
        }
        
        // Message functions
        function showError(message) {
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = `<div class="error">${message}</div>`;
        }
        
        function showSuccess(message) {
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = `<div class="success">${message}</div>`;
        }
        
        function clearMessage() {
            document.getElementById('message-area').innerHTML = '';
        }
        
        // Helper functions
        window.setAmount = function(amount) {
            document.getElementById('amount-input').value = amount;
            
            // Update active button
            document.querySelectorAll('.button-amount').forEach(btn => {
                if (btn.getAttribute('data-amount') === amount.toString()) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            clearMessage();
            updateTokenDisplay();
        }
        
        // Update token display when amount changes
        function updateTokenDisplay() {
            const amountInput = document.getElementById('amount-input');
            const amount = parseFloat(amountInput.value) || 0;
            const tokens = amount * 100; // 100M per ETH
            
            // Update preview
            const preview = document.getElementById('token-preview');
            if (preview) {
                if (amount > 0) {
                    preview.innerHTML = `You will receive: <strong>${tokens}M FARC</strong>`;
                } else {
                    preview.innerHTML = `Enter amount to see tokens`;
                }
            }
            
            if (amount > 0) {
                // Update quick amount buttons to show if it matches
                document.querySelectorAll('.button-amount').forEach(btn => {
                    const btnAmount = parseFloat(btn.getAttribute('data-amount'));
                    if (Math.abs(btnAmount - amount) < 0.0001) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }
        }
        
        // Add event listener for input changes
        window.addEventListener('DOMContentLoaded', function() {
            const amountInput = document.getElementById('amount-input');
            if (amountInput) {
                amountInput.addEventListener('input', updateTokenDisplay);
            }
        });
        
        window.shareToken = async function() {
            try {
                if (isFarcasterFrame && sdk) {
                    // Farcaster native sharing
                    console.log('Using Farcaster native share...');
                    
                    // Create share intent
                    const shareUrl = `https://warpcast.com/~/compose?text=${encodeURIComponent(
                        'üöÄ Just bought $FARC tokens!\n\n' +
                        'The Official Farcaster Token\n' +
                        'üíú Presale: 0.01 ETH = 1M FARC\n' +
                        'üî• Max 5M per wallet\n\n' +
                        'Get yours now! üëá'
                    )}&embeds[]=${encodeURIComponent('https://farc.vercel.app')}`;
                    
                    // Try to open share dialog
                    if (sdk.actions?.openUrl) {
                        await sdk.actions.openUrl({ url: shareUrl });
                    } else {
                        // Fallback to clipboard
                        copyShareText();
                    }
                } else {
                    // Web browser sharing
                    const text = 'Check out $FARC - The Official Farcaster Token! üöÄ\n\nPresale: 0.01 ETH = 1M FARC\nMax 5M per wallet\n\nüü£ Farcaster exclusive\n\nhttps://farc.vercel.app';
                    
                    if (navigator.share) {
                        navigator.share({
                            title: '$FARC Token',
                            text: text
                        }).catch(() => {
                            copyToClipboard(text);
                        });
                    } else {
                        copyToClipboard(text);
                    }
                }
            } catch (error) {
                console.error('Share error:', error);
                copyShareText();
            }
        }
        
        function copyShareText() {
            const text = 'üöÄ Just bought $FARC tokens!\n\nThe Official Farcaster Token\nüíú Presale: 0.01 ETH = 1M FARC\nüî• Max 5M per wallet\n\nGet yours: https://farc.vercel.app';
            copyToClipboard(text);
        }
        
        // Load and display leaderboard
        async function loadLeaderboard() {
            try {
                let leaderboardData = [];
                
                if (ethersProvider) {
                    // Load from contract
                    const readContract = new ethers.Contract(
                        CONTRACT_ADDRESS, 
                        CONTRACT_ABI, 
                        ethersProvider
                    );
                    
                    try {
                        const result = await readContract.getLeaderboard();
                        const buyers = result[0] || result.buyers || [];
                        const amounts = result[1] || result.amounts || [];
                        
                        // Combine and sort
                        leaderboardData = buyers.map(function(buyer, i) {
                            return {
                                address: buyer,
                                amount: parseFloat(ethers.utils.formatUnits(amounts[i], 18))
                            };
                        }).filter(function(item) {
                            return item.amount > 0;
                        }).sort(function(a, b) {
                            return b.amount - a.amount;
                        }).slice(0, 5); // Top 5
                        
                    } catch (contractError) {
                        console.error('Contract call error:', contractError);
                    }
                }
                
                // Display leaderboard
                const leaderboardEl = document.getElementById('leaderboard');
                if (!leaderboardEl) return;
                
                if (leaderboardData.length === 0) {
                    leaderboardEl.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.7;">Be the first to buy FARC! üöÄ</div>';
                } else {
                    let html = '';
                    for (let i = 0; i < leaderboardData.length; i++) {
                        const item = leaderboardData[i];
                        const rank = i + 1;
                        const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '#' + rank;
                        const shortAddress = item.address.slice(0, 6) + '...' + item.address.slice(-4);
                        const amount = (item.amount / 1e6).toFixed(2);
                        
                        html += '<div class="leaderboard-item">' +
                            '<div class="leaderboard-rank">' + medal + '</div>' +
                            '<div class="leaderboard-user">' +
                            '<span>' + shortAddress + '</span>' +
                            (isFarcasterFrame ? '<span style="opacity: 0.7; font-size: 12px;">@farcaster</span>' : '') +
                            '</div>' +
                            '<div class="leaderboard-amount">' + amount + 'M FARC</div>' +
                            '</div>';
                    }
                    leaderboardEl.innerHTML = html;
                }
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                const leaderboardEl = document.getElementById('leaderboard');
                if (leaderboardEl) {
                    leaderboardEl.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.7;">Leaderboard unavailable</div>';
                }
            }
        }
        
        // Start app
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
