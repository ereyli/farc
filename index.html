<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wheel of Fortune</title>
  
  <!-- Farcaster Frame Embed Meta Tag -->
  <meta name="fc:frame" content='{"version":"next","imageUrl":"https://farc.vercel.app/preview.png","button":{"title":"Spin the Wheel","action":{"type":"launch_frame","name":"Wheel of Fortune","url":"https://farc.vercel.app","splashImageUrl":"https://farc.vercel.app/splash.png","splashBackgroundColor":"#6200EA"}}}'>
  
  <style>
    :root {
      --primary-color: #6200EA;
      --secondary-color: #B388FF;
      --accent-color: #FF9100;
      --bg-color: #0F172A;
      --text-color: #E2E8F0;
      --card-bg: #1E293B;
      --border-color: #334155;
      --success-color: #10B981;
      --error-color: #EF4444;
    }
    
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    .header {
      background-color: var(--primary-color);
      color: white;
      padding: 16px;
      text-align: center;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
      position: relative;
      z-index: 10;
    }
    
    .header h1 {
      margin: 0;
      font-size: 24px;
    }
    
    .header p {
      margin: 4px 0 0;
      font-size: 14px;
      opacity: 0.8;
    }
    
    .wallet-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--card-bg);
      margin: 16px;
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .balance-container {
      display: flex;
      flex-direction: column;
    }
    
    .balance-label {
      font-size: 12px;
      opacity: 0.7;
    }
    
    .balance {
      font-weight: bold;
      font-size: 18px;
    }
    
    .wallet-address {
      font-size: 14px;
      color: var(--accent-color);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 150px;
    }
    
    .connect-button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .connect-button:hover {
      background-color: #5000D6;
    }
    
    .fortune-wheel-container {
      position: relative;
      width: 300px;
      height: 300px;
      margin: 32px auto;
    }
    
    .fortune-wheel {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: conic-gradient(
        var(--primary-color) 0% 10%,
        var(--secondary-color) 10% 20%,
        var(--accent-color) 20% 30%,
        var(--primary-color) 30% 40%,
        var(--secondary-color) 40% 50%,
        var(--accent-color) 50% 60%,
        var(--primary-color) 60% 70%,
        var(--secondary-color) 70% 80%,
        var(--accent-color) 80% 90%,
        var(--primary-color) 90% 100%
      );
      transition: transform 3s cubic-bezier(0.17, 0.67, 0.83, 0.67);
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .wheel-center {
      position: absolute;
      width: 50px;
      height: 50px;
      background-color: var(--bg-color);
      border: 2px solid var(--accent-color);
      border-radius: 50%;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .wheel-marker {
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 20px solid var(--accent-color);
      z-index: 5;
    }
    
    .wheel-numbers {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3;
    }
    
    .wheel-number {
      position: absolute;
      left: 50%;
      top: 15px;
      transform-origin: center 135px;
      transform: translateX(-50%);
      font-weight: bold;
      font-size: 18px;
      color: white;
      text-shadow: 0 0 3px rgba(0,0,0,0.8);
    }
    
    .bet-card {
      background-color: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 16px;
      margin: 0 16px 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .bet-card h3 {
      margin-top: 0;
      color: var(--accent-color);
      font-size: 18px;
      text-align: center;
    }
    
    .bet-card p {
      text-align: center;
      margin-bottom: 16px;
    }
    
    .bet-options {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin: 16px 0;
    }
    
    .bet-options .option {
      padding: 12px 0;
      text-align: center;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: bold;
    }
    
    .bet-options .option.selected {
      background-color: var(--primary-color);
      border-color: var(--accent-color);
    }
    
    .bet-options .option:hover {
      border-color: var(--accent-color);
    }
    
    .bet-info {
      background-color: rgba(98, 0, 234, 0.1);
      border: 1px solid var(--primary-color);
      border-radius: 8px;
      padding: 12px;
      margin: 16px 0;
      font-size: 14px;
    }
    
    .bet-info p {
      margin: 8px 0;
      text-align: left;
    }
    
    .payout-info {
      font-weight: bold;
      color: var(--accent-color);
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .action-button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 14px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .action-button:hover {
      background-color: #5000D6;
    }
    
    .action-button.deposit {
      background-color: var(--success-color);
    }
    
    .action-button.deposit:hover {
      background-color: #0B9668;
    }
    
    .action-button.withdraw {
      background-color: var(--accent-color);
    }
    
    .action-button.withdraw:hover {
      background-color: #DD7D00;
    }
    
    .disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .disabled:hover {
      background-color: var(--primary-color);
    }
    
    .result-container {
      text-align: center;
      margin: 16px;
      padding: 16px;
      border-radius: 8px;
      display: none;
    }
    
    .result-win {
      background-color: rgba(16, 185, 129, 0.2);
      border: 1px solid #10B981;
    }
    
    .result-loss {
      background-color: rgba(239, 68, 68, 0.2);
      border: 1px solid #EF4444;
    }
    
    .result-container h3 {
      margin-top: 0;
    }
    
    .pool-info {
      background-color: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 16px;
      margin: 0 16px 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .pool-info h3 {
      margin-top: 0;
      color: var(--accent-color);
      font-size: 18px;
      text-align: center;
    }
    
    .pool-stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }
    
    .pool-stat {
      background-color: rgba(98, 0, 234, 0.1);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }
    
    .pool-stat-label {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 8px;
    }
    
    .pool-stat-value {
      font-weight: bold;
      font-size: 18px;
    }
    
    .recent-plays {
      background-color: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 16px;
      margin: 0 16px 32px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .recent-plays h3 {
      margin-top: 0;
      color: var(--accent-color);
      font-size: 18px;
      text-align: center;
      margin-bottom: 16px;
    }
    
    .play-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .play-item {
      background-color: rgba(98, 0, 234, 0.05);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
    }
    
    .play-result {
      font-weight: bold;
    }
    
    .play-result.win {
      color: var(--success-color);
    }
    
    .play-result.lose {
      color: var(--error-color);
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(15, 23, 42, 0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 4px solid rgba(96, 165, 250, 0.1);
      border-top-color: var(--accent-color);
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 16px;
      font-weight: bold;
    }
    
    .wrong-network {
      text-align: center;
      padding: 32px 16px;
      color: var(--error-color);
      display: none;
    }
    
    .wrong-network p {
      margin-bottom: 16px;
    }
    
    .switch-network-button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(15, 23, 42, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }
    
    .modal-content {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .modal-title {
      margin: 0;
      font-size: 18px;
      color: var(--accent-color);
    }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 24px;
      cursor: pointer;
    }
    
    .modal-body {
      margin-bottom: 16px;
    }
    
    .amount-input {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .amount-input input {
      flex: 1;
      background-color: var(--bg-color);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
    }
    
    .amount-input input:focus {
      border-color: var(--accent-color);
    }
    
    .eth-suffix {
      margin-left: 8px;
      font-weight: bold;
    }
    
    .amount-presets {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .amount-preset {
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      padding: 8px;
      border-radius: 8px;
      font-size: 12px;
      text-align: center;
      cursor: pointer;
    }
    
    .amount-preset:hover {
      border-color: var(--accent-color);
    }
    
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    .modal-button {
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
    
    .modal-button.cancel {
      background-color: rgba(0,0,0,0.2);
      color: var(--text-color);
    }
    
    .modal-button.confirm {
      background-color: var(--primary-color);
      color: white;
    }
    
    @media (max-width: 480px) {
      .bet-options {
        grid-template-columns: repeat(5, 1fr);
      }
      
      .pool-stats {
        grid-template-columns: 1fr;
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Wheel of Fortune</h1>
    <p>Spin the wheel & test your luck on Base</p>
  </div>
  
  <div class="wallet-info" id="wallet-info">
    <div class="balance-container">
      <div class="balance-label">Your Balance</div>
      <div class="balance" id="player-balance">0.00 ETH</div>
    </div>
    <button class="connect-button" id="connect-wallet">Connect Wallet</button>
  </div>
  
  <div class="wrong-network" id="wrong-network">
    <p>This app runs on the Base network. Please switch your wallet to Base.</p>
    <button class="switch-network-button" id="switch-network">Switch to Base</button>
  </div>
  
  <div class="fortune-wheel-container">
    <div class="fortune-wheel" id="wheel"></div>
    <div class="wheel-center">Spin</div>
    <div class="wheel-marker"></div>
    
    <div class="wheel-numbers">
      <div class="wheel-number" style="transform: translateX(-50%) rotate(0deg)">0</div>
      <div class="wheel-number" style="transform: translateX(-50%) rotate(36deg)">1</div>
      <div class="wheel-number" style="transform: translateX(-50%) rotate(72deg)">2</div>
      <div class="wheel-number" style="transform: translateX(-50%) rotate(108deg)">3</div>
      <div class="wheel-number" style="transform: translateX(-50%) rotate(144deg)">4</div>
      <div class="wheel-number" style="transform: translateX(-50%) rotate(180deg)">5</div>
      <div class="wheel-number" style="transform: translateX(-50%) rotate(216deg)">6</div>
      <div class="wheel-number" style="transform: translateX(-50%) rotate(252deg)">7</div>
      <div class="wheel-number" style="transform: translateX(-50%) rotate(288deg)">8</div>
      <div class="wheel-number" style="transform: translateX(-50%) rotate(324deg)">9</div>
    </div>
  </div>
  
  <div class="bet-card">
    <h3>Select Your Number</h3>
    <p>Guess where the wheel will stop (0-9)</p>
    
    <div class="bet-options" id="wheel-options">
      <div class="option" data-value="0">0</div>
      <div class="option" data-value="1">1</div>
      <div class="option" data-value="2">2</div>
      <div class="option" data-value="3">3</div>
      <div class="option" data-value="4">4</div>
      <div class="option" data-value="5">5</div>
      <div class="option" data-value="6">6</div>
      <div class="option" data-value="7">7</div>
      <div class="option" data-value="8">8</div>
      <div class="option" data-value="9">9</div>
    </div>
    
    <div class="bet-info">
      <p>Fixed bet amount: <strong>0.001 ETH</strong></p>
      <p class="payout-info">Potential win: <span id="wheel-payout">0.00 ETH</span></p>
    </div>
    
    <div class="action-buttons">
      <button class="action-button deposit" id="deposit-button">Deposit</button>
      <button class="action-button withdraw" id="withdraw-button">Withdraw</button>
      <button class="action-button spin disabled" id="spin-button" style="grid-column: span 2;">Spin the Wheel</button>
    </div>
  </div>
  
  <div class="result-container" id="wheel-result">
    <h3>Result</h3>
    <p id="wheel-result-text"></p>
  </div>
  
  <div class="pool-info">
    <h3>Pool Information</h3>
    <div class="pool-stats">
      <div class="pool-stat">
        <div class="pool-stat-label">Total Pool Balance</div>
        <div class="pool-stat-value" id="pool-balance">0.00 ETH</div>
      </div>
      <div class="pool-stat">
        <div class="pool-stat-label">Total Bets Placed</div>
        <div class="pool-stat-value" id="total-bets">0</div>
      </div>
      <div class="pool-stat">
        <div class="pool-stat-label">Total Winnings Paid</div>
        <div class="pool-stat-value" id="total-winnings">0.00 ETH</div>
      </div>
    </div>
  </div>
  
  <div class="recent-plays">
    <h3>Your Recent Plays</h3>
    <ul class="play-list" id="recent-plays-list">
      <li class="play-item">
        <span>No game history yet.</span>
      </li>
    </ul>
  </div>
  
  <div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loading-text">Processing your transaction...</div>
  </div>
  
  <div class="modal" id="deposit-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Deposit ETH</h3>
        <button class="modal-close" id="deposit-close">&times;</button>
      </div>
      <div class="modal-body">
        <p>How much ETH would you like to deposit to the pool?</p>
        <div class="amount-input">
          <input type="number" id="deposit-amount" placeholder="0.01" step="0.001" min="0.001">
          <span class="eth-suffix">ETH</span>
        </div>
        <div class="amount-presets">
          <div class="amount-preset" data-amount="0.001">0.001</div>
          <div class="amount-preset" data-amount="0.01">0.01</div>
          <div class="amount-preset" data-amount="0.05">0.05</div>
          <div class="amount-preset" data-amount="0.1">0.1</div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-button cancel" id="deposit-cancel">Cancel</button>
        <button class="modal-button confirm" id="deposit-confirm">Deposit</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="withdraw-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Withdraw ETH</h3>
        <button class="modal-close" id="withdraw-close">&times;</button>
      </div>
      <div class="modal-body">
        <p>How much ETH would you like to withdraw from the pool?</p>
        <div class="amount-input">
          <input type="number" id="withdraw-amount" placeholder="0.01" step="0.001" min="0.001">
          <span class="eth-suffix">ETH</span>
        </div>
        <div class="amount-presets">
          <div class="amount-preset" data-amount="0.001">0.001</div>
          <div class="amount-preset" data-amount="0.01">0.01</div>
          <div class="amount-preset" data-amount="0.05">0.05</div>
          <div class="amount-preset" data-amount="0.1">0.1</div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-button cancel" id="withdraw-cancel">Cancel</button>
        <button class="modal-button confirm" id="withdraw-confirm">Withdraw</button>
      </div>
    </div>
  </div>

  <!-- Farcaster SDK and Ethereum JS libraries -->
  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/frame-sdk';
    import { ethers } from 'https://esm.sh/ethers@6.10.0';
    
    // WheelPool contract ABI
    const contractABI = [
      "function deposit() external payable",
      "function withdraw(uint256 _amount) external",
      "function placeBet(uint8 _choice) external returns (uint256)",
      "function getPlayerBalance(address _player) external view returns (uint256)",
      "function getPlayerBets(address _player) external view returns (uint256[])",
      "function getBetInfo(uint256 _betId) external view returns (address player, uint256 amount, uint8 choice, bool settled, bool won, uint256 payout)",
      "function getPoolInfo() external view returns (uint256 totalBalance, uint256 totalBets, uint256 totalWinnings)",
      "event BetPlaced(uint256 indexed betId, address indexed player, uint256 amount, uint8 choice)",
      "event BetSettled(uint256 indexed betId, address indexed player, bool won, uint256 payout, uint8 result)",
      "event FundsDeposited(address indexed player, uint256 amount)",
      "event FundsWithdrawn(address indexed player, uint256 amount)",
      "event WheelResult(uint256 indexed betId, uint8 result)"
    ];
    
    // Base network settings
    const baseChainId = 8453; // Base Mainnet
    const expectedNetwork = {
      chainId: ethers.toQuantity(baseChainId),
      chainName: "Base",
      nativeCurrency: {
        name: "Ethereum",
        symbol: "ETH",
        decimals: 18
      },
      rpcUrls: ["https://mainnet.base.org"],
      blockExplorerUrls: ["https://basescan.org"]
    };
    
    // Contract address - update after deploying the contract
    const contractAddress = "0xYourContractAddressHere";
    
    // App state
    let provider;
    let signer;
    let contract;
    let userAddress;
    let wheelChoice = null;
    let isSpinning = false;
    let isCorrectNetwork = false;
    let playerBalance = 0;
    let recentPlays = [];
    let poolInfo = {
      totalBalance: 0,
      totalBets: 0,
      totalWinnings: 0
    };
    
    // DOM Elements
    const wheelOptions = document.querySelectorAll('#wheel-options .option');
    const wheelPayoutElement = document.getElementById('wheel-payout');
    const spinButton = document.getElementById('spin-button');
    const wheelResult = document.getElementById('wheel-result');
    const wheelResultText = document.getElementById('wheel-result-text');
    const recentPlaysList = document.getElementById('recent-plays-list');
    const connectWalletButton = document.getElementById('connect-wallet');
    const playerBalanceElement = document.getElementById('player-balance');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const wrongNetworkElement = document.getElementById('wrong-network');
    const switchNetworkButton = document.getElementById('switch-network');
    const wheel = document.getElementById('wheel');
    
    // Pool info elements
    const poolBalanceElement = document.getElementById('pool-balance');
    const totalBetsElement = document.getElementById('total-bets');
    const totalWinningsElement = document.getElementById('total-winnings');
    
    // Modal elements
    const depositButton = document.getElementById('deposit-button');
    const withdrawButton = document.getElementById('withdraw-button');
    const depositModal = document.getElementById('deposit-modal');
    const withdrawModal = document.getElementById('withdraw-modal');
    const depositClose = document.getElementById('deposit-close');
    const withdrawClose = document.getElementById('withdraw-close');
    const depositCancel = document.getElementById('deposit-cancel');
    const withdrawCancel = document.getElementById('withdraw-cancel');
    const depositConfirm = document.getElementById('deposit-confirm');
    const withdrawConfirm = document.getElementById('withdraw-confirm');
    const depositAmount = document.getElementById('deposit-amount');
    const withdrawAmount = document.getElementById('withdraw-amount');
    const depositPresets = depositModal.querySelectorAll('.amount-preset');
    const withdrawPresets = withdrawModal.querySelectorAll('.amount-preset');
    
    // Initialize when Mini App is ready
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await sdk.actions.ready();
        console.log('Wheel of Fortune Mini App ready!');
        
        // Check wallet connection
        checkConnection();
        
        // Setup event listeners
        setupEventListeners();
      } catch (error) {
        console.error('Initialization error:', error);
      }
    });
    
    // Setup event listeners
    function setupEventListeners() {
      // Wheel number options
      wheelOptions.forEach(option => {
        option.addEventListener('click', () => {
          wheelOptions.forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          wheelChoice = parseInt(option.dataset.value);
          updateWheelPayoutInfo();
          updateSpinButtonState();
        });
      });
      
      // Spin button
      spinButton.addEventListener('click', spinTheWheel);
      
      // Connect wallet button
      connectWalletButton.addEventListener('click', connectWallet);
      
      // Switch network button
      switchNetworkButton.addEventListener('click', switchToBaseNetwork);
      
      // Deposit & withdraw buttons
      depositButton.addEventListener('click', () => {
        depositModal.style.display = 'flex';
      });
      
      withdrawButton.addEventListener('click', () => {
        withdrawModal.style.display = 'flex';
      });
      
      // Modal close buttons
      depositClose.addEventListener('click', () => {
        depositModal.style.display = 'none';
      });
      
      withdrawClose.addEventListener('click', () => {
        withdrawModal.style.display = 'none';
      });
      
      // Modal cancel buttons
      depositCancel.addEventListener('click', () => {
        depositModal.style.display = 'none';
      });
      
      withdrawCancel.addEventListener('click', () => {
        withdrawModal.style.display = 'none';
      });
      
      // Modal confirm buttons
      depositConfirm.addEventListener('click', handleDeposit);
      withdrawConfirm.addEventListener('click', handleWithdraw);
      
      // Deposit amount presets
      depositPresets.forEach(preset => {
        preset.addEventListener('click', () => {
          depositAmount.value = preset.dataset.amount;
        });
      });
      
      // Withdraw amount presets
      withdrawPresets.forEach(preset => {
        preset.addEventListener('click', () => {
          withdrawAmount.value = preset.dataset.amount;
        });
      });
    }
    
    // Check wallet connection
    async function checkConnection() {
      try {
        // Get ethProvider from Farcaster SDK
        provider = new ethers.BrowserProvider(sdk.wallet.ethProvider);
        
        // Check network
        const network = await provider.getNetwork();
        isCorrectNetwork = network.chainId === BigInt(baseChainId);
        
        if (!isCorrectNetwork) {
          wrongNetworkElement.style.display = 'block';
          document.querySelector('.fortune-wheel-container').style.display = 'none';
          document.querySelector('.bet-card').style.display = 'none';
          document.querySelector('.pool-info').style.display = 'none';
          document.querySelector('.recent-plays').style.display = 'none';
          return;
        } else {
          wrongNetworkElement.style.display = 'none';
          document.querySelector('.fortune-wheel-container').style.display = 'block';
          document.querySelector('.bet-card').style.display = 'block';
          document.querySelector('.pool-info').style.display = 'block';
          document.querySelector('.recent-plays').style.display = 'block';
        }
        
        // Get accounts
        const accounts = await provider.listAccounts();
        
        if (accounts.length > 0) {
          signer = accounts[0];
          userAddress = signer.address;
          
          // Show wallet address
          connectWalletButton.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
          
          // Contract connection
          contract = new ethers.Contract(contractAddress, contractABI, provider);
          
          // Load player balance
          await loadPlayerBalance();
          
          // Load pool info
          await loadPoolInfo();
          
          // Load game history
          await loadRecentPlays();
          
          // Update UI
          updateWheelPayoutInfo();
          updateSpinButtonState();
        }
      } catch (error) {
        console.error('Connection error:', error);
      }
    }
    
    // Connect wallet
    async function connectWallet() {
      try {
        showLoading('Connecting wallet...');
        
        if (sdk.wallet.ethProvider.request) {
          await sdk.wallet.ethProvider.request({ method: 'eth_requestAccounts' });
          await checkConnection();
        }
        
        hideLoading();
      } catch (error) {
        console.error('Wallet connection error:', error);
        hideLoading();
      }
    }
    
    // Switch to Base network
    async function switchToBaseNetwork() {
      try {
        showLoading('Switching to Base network...');
        
        if (sdk.wallet.ethProvider.request) {
          try {
            // Try to switch network first
            await sdk.wallet.ethProvider.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: expectedNetwork.chainId }],
            });
          } catch (switchError) {
            // If network isn't added, add it
            if (switchError.code === 4902) {
              await sdk.wallet.ethProvider.request({
                method: 'wallet_addEthereumChain',
                params: [expectedNetwork],
              });
            } else {
              throw switchError;
            }
          }
          
          await checkConnection();
        }
        
        hideLoading();
      } catch (error) {
        console.error('Network switching error:', error);
        hideLoading();
      }
    }
    
    // Load player balance
    async function loadPlayerBalance() {
      try {
        if (!userAddress || !contract) return;
        
        const balance = await contract.getPlayerBalance(userAddress);
        playerBalance = parseFloat(ethers.formatEther(balance));
        
        playerBalanceElement.textContent = `${playerBalance.toFixed(4)} ETH`;
      } catch (error) {
        console.error('Balance loading error:', error);
      }
    }
    
    // Load pool info
    async function loadPoolInfo() {
      try {
        if (!contract) return;
        
        const result = await contract.getPoolInfo();
        
        poolInfo = {
          totalBalance: parseFloat(ethers.formatEther(result[0])),
          totalBets: parseInt(result[1]),
          totalWinnings: parseFloat(ethers.formatEther(result[2]))
        };
        
        // Update UI
        poolBalanceElement.textContent = `${poolInfo.totalBalance.toFixed(4)} ETH`;
        totalBetsElement.textContent = poolInfo.totalBets;
        totalWinningsElement.textContent = `${poolInfo.totalWinnings.toFixed(4)} ETH`;
      } catch (error) {
        console.error('Pool info loading error:', error);
      }
    }
    
    // Handle deposit
    async function handleDeposit() {
      if (!signer || !contract || !isCorrectNetwork) {
        alert('Please connect your wallet to the Base network first!');
        return;
      }
      
      const amount = parseFloat(depositAmount.value);
      if (isNaN(amount) || amount <= 0) {
        alert('Please enter a valid amount');
        return;
      }
      
      try {
        depositModal.style.display = 'none';
        showLoading('Depositing ETH...');
        
        // Connect contract with signer
        const connectedContract = contract.connect(signer);
        
        // Deposit
        const tx = await connectedContract.deposit({
          value: ethers.parseEther(amount.toString()),
          gasLimit: 300000 // Gas limit
        });
        
        loadingText.textContent = 'Confirming transaction...';
        
        // Wait for transaction confirmation
        const receipt = await tx.wait();
        console.log('Deposit transaction confirmed:', receipt);
        
        // Reload balances
        await loadPlayerBalance();
        await loadPoolInfo();
        
        // Show confirmation
        alert(`Successfully deposited ${amount} ETH`);
        
        hideLoading();
      } catch (error) {
        console.error('Deposit error:', error);
        hideLoading();
        alert('Error depositing: ' + error.message);
      }
    }
    
    // Handle withdraw
    async function handleWithdraw() {
      if (!signer || !contract || !isCorrectNetwork) {
        alert('Please connect your wallet to the Base network first!');
        return;
      }
      
      const amount = parseFloat(withdrawAmount.value);
      if (isNaN(amount) || amount <= 0) {
        alert('Please enter a valid amount');
        return;
      }
      
      if (amount > playerBalance) {
        alert('Insufficient balance');
        return;
      }
      
      try {
        withdrawModal.style.display = 'none';
        showLoading('Withdrawing ETH...');
        
        // Connect contract with signer
        const connectedContract = contract.connect(signer);
        
        // Withdraw
        const tx = await connectedContract.withdraw(ethers.parseEther(amount.toString()), {
          gasLimit: 300000 // Gas limit
        });
        
        loadingText.textContent = 'Confirming transaction...';
        
        // Wait for transaction confirmation
        const receipt = await tx.wait();
        console.log('Withdraw transaction confirmed:', receipt);
        
        // Reload balances
        await loadPlayerBalance();
        await loadPoolInfo();
        
        // Show confirmation
        alert(`Successfully withdrew ${amount} ETH`);
        
        hideLoading();
      } catch (error) {
        console.error('Withdraw error:', error);
        hideLoading();
        alert('Error withdrawing: ' + error.message);
      }
    }
    
    // Spin the wheel
    async function spinTheWheel() {
      if (!signer || !contract || !isCorrectNetwork) {
        if (!isCorrectNetwork) {
          alert('Please switch to Base network first!');
          return;
        }
        alert('Please connect your wallet first!');
        return;
      }
      
      if (isSpinning || wheelChoice === null) {
        return;
      }
      
      // Check if player has enough balance
      if (playerBalance < 0.001) {
        alert('Insufficient balance. Please deposit at least 0.001 ETH.');
        return;
      }
      
      try {
        showLoading('Placing bet...');
        isSpinning = true;
        
        // Connect contract with signer
        const connectedContract = contract.connect(signer);
        
        // Place bet
        const tx = await connectedContract.placeBet(wheelChoice, {
          gasLimit: 300000 // Gas limit
        });
        
        loadingText.textContent = 'Confirming bet...';
        
        // Wait for transaction confirmation
        const receipt = await tx.wait();
        console.log('Bet transaction confirmed:', receipt);
        
        // Look for events
        let result = 0;
        let betId = 0;
        let won = false;
        let payout = 0;
        
        // Find the BetSettled event
        for (const event of receipt.logs) {
          try {
            const parsedLog = contract.interface.parseLog(event);
            
            if (parsedLog && parsedLog.name === 'BetSettled') {
              betId = parsedLog.args[0];
              won = parsedLog.args[2];
              payout = parseFloat(ethers.formatEther(parsedLog.args[3]));
            }
            
            if (parsedLog && parsedLog.name === 'WheelResult') {
              result = parsedLog.args[1];
            }
          } catch (e) {
            // Not our event, skip
          }
        }
        
        // If we couldn't find the events, get bet info from contract
        if (betId === 0) {
          // Get last bet ID
          const bets = await contract.getPlayerBets(userAddress);
          if (bets.length > 0) {
            betId = bets[bets.length - 1];
            
            // Get bet info
            const betInfo = await contract.getBetInfo(betId);
            won = betInfo[4];
            payout = parseFloat(ethers.formatEther(betInfo[5]));
            
            // We don't know the result, so use a random one for animation
            result = Math.floor(Math.random() * 10);
          }
        }
        
        // Animate the wheel
        animateWheel(result);
        
        // Reload balances and pool info
        await loadPlayerBalance();
        await loadPoolInfo();
        
        // Add to play history
        const newPlay = {
          choice: wheelChoice,
          result: result,
          amount: 0.001,
          won: won,
          payout: payout,
          time: new Date().toISOString()
        };
        
        recentPlays.unshift(newPlay);
        updateRecentPlaysList();
        
        // Show result after wheel animation finishes
        setTimeout(() => {
          showGameResult(result, won, payout);
          isSpinning = false;
          hideLoading();
        }, 3000);
      } catch (error) {
        console.error('Bet error:', error);
        isSpinning = false;
        hideLoading();
        alert('Error placing bet: ' + error.message);
      }
    }
    
    // Animate wheel
    function animateWheel(result) {
      // Calculate wheel segments
      const segmentAngle = 360 / 10; // 10 segments (0-9)
      const extraRotations = 5; // Extra rotations
      const randomOffset = Math.random() * segmentAngle; // Random position within segment
      const targetAngle = ((result) * segmentAngle) + randomOffset;
      const totalRotation = (extraRotations * 360) + targetAngle;
      
      // Spin wheel
      wheel.style.transform = `rotate(${totalRotation}deg)`;
    }
    
    // Show game result
    function showGameResult(result, won, payout) {
      if (won) {
        wheelResult.className = 'result-container result-win';
        wheelResultText.innerHTML = `
          <strong>Congratulations!</strong><br>
          Result: ${result}<br>
          You chose: ${wheelChoice}<br>
          You won ${payout.toFixed(4)} ETH!
        `;
      } else {
        wheelResult.className = 'result-container result-loss';
        wheelResultText.innerHTML = `
          <strong>You lost</strong><br>
          Result: ${result}<br>
          You chose: ${wheelChoice}<br>
          You lost 0.001 ETH.
        `;
      }
      
      wheelResult.style.display = 'block';
      
      // Hide result after 5 seconds
      setTimeout(() => {
        wheelResult.style.display = 'none';
      }, 5000);
    }
    
    // Load recent plays
    async function loadRecentPlays() {
      try {
        if (!userAddress || !contract) return;
        
        // Get player bets
        const betIds = await contract.getPlayerBets(userAddress);
        
        // Only fetch the last 5 bets
        const recentBetIds = betIds.slice(-5);
        
        recentPlays = [];
        
        // Load bet info for each bet
        for (const betId of recentBetIds) {
          const betInfo = await contract.getBetInfo(betId);
          
          // Skip if not settled
          if (!betInfo[3]) continue;
          
          recentPlays.push({
            choice: betInfo[2],
            result: 0, // We don't have this info
            amount: parseFloat(ethers.formatEther(betInfo[1])),
            won: betInfo[4],
            payout: parseFloat(ethers.formatEther(betInfo[5])),
            time: new Date().toISOString() // We don't have timestamp
          });
        }
        
        updateRecentPlaysList();
      } catch (error) {
        console.error('Game history loading error:', error);
      }
    }
    
    // Update recent plays list
    function updateRecentPlaysList() {
      if (recentPlays.length === 0) {
        recentPlaysList.innerHTML = `
          <li class="play-item">
            <span>No game history yet.</span>
          </li>
        `;
        return;
      }
      
      recentPlaysList.innerHTML = '';
      
      recentPlays.forEach(play => {
        const timeStr = new Date(play.time).toLocaleTimeString();
        
        const li = document.createElement('li');
        li.className = 'play-item';
        li.innerHTML = `
          <div>
            <strong>Chosen: ${play.choice}</strong>
            ${play.result !== undefined ? `Result: ${play.result}` : ''}
            <br>
            <small>${play.amount} ETH, ${timeStr}</small>
          </div>
          <div class="play-result ${play.won ? 'win' : 'lose'}">
            ${play.won ? `Won ${play.payout.toFixed(4)}` : 'Lost'}
          </div>
        `;
        
        recentPlaysList.appendChild(li);
      });
    }
    
    // Update wheel payout info
    function updateWheelPayoutInfo() {
      if (wheelChoice !== null) {
        // 10 numbers, 1 chance, payout 9.5x to account for house edge
        const payout = 0.001 * 9.5;
        wheelPayoutElement.textContent = `${payout.toFixed(4)} ETH`;
      } else {
        wheelPayoutElement.textContent = '0.00 ETH';
      }
    }
    
    // Update spin button state
    function updateSpinButtonState() {
      if (wheelChoice !== null && playerBalance >= 0.001 && !isSpinning) {
        spinButton.classList.remove('disabled');
      } else {
        spinButton.classList.add('disabled');
      }
    }
    
    // Show loading
    function showLoading(text) {
      loadingText.textContent = text;
      loadingOverlay.style.display = 'flex';
    }
    
    // Hide loading
    function hideLoading() {
      loadingOverlay.style.display = 'none';
    }
  </script>
</body>
</html>
