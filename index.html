<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wheel of Fortune</title>
  
  <!-- Farcaster Frame Embed Meta Tag -->
  <meta name="fc:frame" content='{"version":"next","imageUrl":"https://farc.vercel.app/preview.png","button":{"title":"Spin the Wheel","action":{"type":"launch_frame","name":"Wheel of Fortune","url":"https://farc.vercel.app","splashImageUrl":"https://farc.vercel.app/splash.png","splashBackgroundColor":"#6200EA"}}}'>
  
  <style>
    :root {
      --primary-color: #6200EA;
      --secondary-color: #B388FF;
      --accent-color: #FF9100;
      --bg-color: #0F172A;
      --text-color: #E2E8F0;
      --card-bg: #1E293B;
      --border-color: #334155;
      --success-color: #10B981;
      --error-color: #EF4444;
    }
    
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    .header {
      background-color: var(--primary-color);
      color: white;
      padding: 16px;
      text-align: center;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
      position: relative;
      z-index: 10;
    }
    
    .header h1 {
      margin: 0;
      font-size: 24px;
    }
    
    .header p {
      margin: 4px 0 0;
      font-size: 14px;
      opacity: 0.8;
    }
    
    .wallet-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--card-bg);
      margin: 16px;
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .balance-container {
      display: flex;
      flex-direction: column;
    }
    
    .balance-label {
      font-size: 12px;
      opacity: 0.7;
    }
    
    .balance {
      font-weight: bold;
      font-size: 18px;
    }
    
    .wallet-address {
      font-size: 14px;
      color: var(--accent-color);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 150px;
    }
    
    .connect-button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .connect-button:hover {
      background-color: #5000D6;
    }
    
    .fortune-wheel-container {
      position: relative;
      width: 300px;
      height: 300px;
      margin: 32px auto;
    }
    
    .fortune-wheel {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: conic-gradient(
        var(--primary-color) 0% 10%,
        var(--secondary-color) 10% 20%,
        var(--accent-color) 20% 30%,
        var(--primary-color) 30% 40%,
        var(--secondary-color) 40% 50%,
        var(--accent-color) 50% 60%,
        var(--primary-color) 60% 70%,
        var(--secondary-color) 70% 80%,
        var(--accent-color) 80% 90%,
        var(--primary-color) 90% 100%
      );
      transition: transform 3s cubic-bezier(0.17, 0.67, 0.83, 0.67);
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      position: relative;
    }
    
    .wheel-center {
      position: absolute;
      width: 50px;
      height: 50px;
      background-color: var(--bg-color);
      border: 2px solid var(--accent-color);
      border-radius: 50%;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    .wheel-marker {
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 20px solid var(--accent-color);
      z-index: 5;
    }
    
    .wheel-numbers {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      border-radius: 50%;
      z-index: 3;
      pointer-events: none;
    }
    
    .wheel-number {
      position: absolute;
      width: 30px;
      height: 30px;
      text-align: center;
      line-height: 30px;
      font-weight: bold;
      font-size: 20px;
      color: white;
      text-shadow: 0 1px 3px rgba(0,0,0,0.9);
      transform-origin: center center;
      left: calc(50% - 15px);
      top: 50%;
      margin-top: -15px;
    }
    
    .bet-card {
      background-color: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 16px;
      margin: 0 16px 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .bet-card h3 {
      margin-top: 0;
      color: var(--accent-color);
      font-size: 18px;
      text-align: center;
    }
    
    .bet-card p {
      text-align: center;
      margin-bottom: 16px;
    }
    
    .bet-options {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin: 16px 0;
    }
    
    .bet-options .option {
      padding: 12px 0;
      text-align: center;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: bold;
    }
    
    .bet-options .option.selected {
      background-color: var(--primary-color);
      border-color: var(--accent-color);
    }
    
    .bet-options .option:hover {
      border-color: var(--accent-color);
    }
    
    .bet-info {
      background-color: rgba(98, 0, 234, 0.1);
      border: 1px solid var(--primary-color);
      border-radius: 8px;
      padding: 12px;
      margin: 16px 0;
      font-size: 14px;
    }
    
    .bet-info p {
      margin: 8px 0;
      text-align: left;
    }
    
    .payout-info {
      font-weight: bold;
      color: var(--accent-color);
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .action-button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 14px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .action-button:hover {
      background-color: #5000D6;
    }
    
    .action-button.deposit {
      background-color: var(--success-color);
    }
    
    .action-button.deposit:hover {
      background-color: #0B9668;
    }
    
    .action-button.withdraw {
      background-color: var(--accent-color);
    }
    
    .action-button.withdraw:hover {
      background-color: #DD7D00;
    }
    
    .disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .disabled:hover {
      background-color: var(--primary-color);
    }
    
    .result-container {
      text-align: center;
      margin: 16px;
      padding: 16px;
      border-radius: 8px;
      display: none;
    }
    
    .result-win {
      background-color: rgba(16, 185, 129, 0.2);
      border: 1px solid #10B981;
    }
    
    .result-loss {
      background-color: rgba(239, 68, 68, 0.2);
      border: 1px solid #EF4444;
    }
    
    .result-container h3 {
      margin-top: 0;
    }
    
    .pool-info {
      background-color: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 16px;
      margin: 0 16px 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .pool-info h3 {
      margin-top: 0;
      color: var(--accent-color);
      font-size: 18px;
      text-align: center;
    }
    
    .pool-stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }
    
    .pool-stat {
      background-color: rgba(98, 0, 234, 0.1);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }
    
    .pool-stat-label {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 8px;
    }
    
    .pool-stat-value {
      font-weight: bold;
      font-size: 18px;
    }
    
    .recent-plays {
      background-color: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 16px;
      margin: 0 16px 32px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .recent-plays h3 {
      margin-top: 0;
      color: var(--accent-color);
      font-size: 18px;
      text-align: center;
      margin-bottom: 16px;
    }
    
    .play-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .play-item {
      background-color: rgba(98, 0, 234, 0.05);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
    }
    
    .play-result {
      font-weight: bold;
    }
    
    .play-result.win {
      color: var(--success-color);
    }
    
    .play-result.lose {
      color: var(--error-color);
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(15, 23, 42, 0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 4px solid rgba(96, 165, 250, 0.1);
      border-top-color: var(--accent-color);
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 16px;
      font-weight: bold;
    }
    
    .wrong-network {
      text-align: center;
      padding: 32px 16px;
      color: var(--error-color);
      display: none;
    }
    
    .wrong-network p {
      margin-bottom: 16px;
    }
    
    .switch-network-button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(15, 23, 42, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }
    
    .modal-content {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .modal-title {
      margin: 0;
      font-size: 18px;
      color: var(--accent-color);
    }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 24px;
      cursor: pointer;
    }
    
    .modal-body {
      margin-bottom: 16px;
    }
    
    .amount-input {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .amount-input input {
      flex: 1;
      background-color: var(--bg-color);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
    }
    
    .amount-input input:focus {
      border-color: var(--accent-color);
    }
    
    .eth-suffix {
      margin-left: 8px;
      font-weight: bold;
    }
    
    .amount-presets {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .amount-preset {
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      padding: 8px;
      border-radius: 8px;
      font-size: 12px;
      text-align: center;
      cursor: pointer;
    }
    
    .amount-preset:hover {
      border-color: var(--accent-color);
    }
    
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    .modal-button {
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
    
    .modal-button.cancel {
      background-color: rgba(0,0,0,0.2);
      color: var(--text-color);
    }
    
    .modal-button.confirm {
      background-color: var(--primary-color);
      color: white;
    }
    
    @media (max-width: 480px) {
      .bet-options {
        grid-template-columns: repeat(5, 1fr);
      }
      
      .pool-stats {
        grid-template-columns: 1fr;
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Wheel of Fortune</h1>
    <p>Spin the wheel & test your luck on Base</p>
  </div>
  
  <div class="wallet-info" id="wallet-info">
    <div class="balance-container">
      <div class="balance-label">Your Balance</div>
      <div class="balance" id="player-balance">0.00 ETH</div>
    </div>
    <button class="connect-button" id="connect-wallet">Connect Wallet</button>
  </div>
  
  <div class="wrong-network" id="wrong-network">
    <p>This app runs on the Base network. Please switch your wallet to Base.</p>
    <button class="switch-network-button" id="switch-network">Switch to Base</button>
  </div>
  
  <div class="fortune-wheel-container">
    <div class="fortune-wheel" id="wheel"></div>
    <div class="wheel-center">Spin</div>
    <div class="wheel-marker"></div>
    
    <div class="wheel-numbers">
      <div class="wheel-number" style="transform: translateY(-120px)">0</div>
      <div class="wheel-number" style="transform: rotate(36deg) translateY(-120px)">1</div>
      <div class="wheel-number" style="transform: rotate(72deg) translateY(-120px)">2</div>
      <div class="wheel-number" style="transform: rotate(108deg) translateY(-120px)">3</div>
      <div class="wheel-number" style="transform: rotate(144deg) translateY(-120px)">4</div>
      <div class="wheel-number" style="transform: rotate(180deg) translateY(-120px)">5</div>
      <div class="wheel-number" style="transform: rotate(216deg) translateY(-120px)">6</div>
      <div class="wheel-number" style="transform: rotate(252deg) translateY(-120px)">7</div>
      <div class="wheel-number" style="transform: rotate(288deg) translateY(-120px)">8</div>
      <div class="wheel-number" style="transform: rotate(324deg) translateY(-120px)">9</div>
    </div>
  </div>
  
  <div class="bet-card">
    <h3>Select Your Number</h3>
    <p>Guess where the wheel will stop (0-9)</p>
    
    <div class="bet-options" id="wheel-options">
      <div class="option" data-value="0">0</div>
      <div class="option" data-value="1">1</div>
      <div class="option" data-value="2">2</div>
      <div class="option" data-value="3">3</div>
      <div class="option" data-value="4">4</div>
      <div class="option" data-value="5">5</div>
      <div class="option" data-value="6">6</div>
      <div class="option" data-value="7">7</div>
      <div class="option" data-value="8">8</div>
      <div class="option" data-value="9">9</div>
    </div>
    
    <div class="bet-info">
      <p>Fixed bet amount: <strong>0.001 ETH</strong></p>
      <p class="payout-info">Potential win: <span id="wheel-payout">0.00 ETH</span></p>
    </div>
    
    <div class="action-buttons">
      <button class="action-button deposit" id="deposit-button">Deposit</button>
      <button class="action-button withdraw" id="withdraw-button">Withdraw</button>
      <button class="action-button spin disabled" id="spin-button" style="grid-column: span 2;">Spin the Wheel</button>
    </div>
  </div>
  
  <div class="result-container" id="wheel-result">
    <h3>Result</h3>
    <p id="wheel-result-text"></p>
  </div>
  
  <div class="pool-info">
    <h3>Pool Information</h3>
    <div class="pool-stats">
      <div class="pool-stat">
        <div class="pool-stat-label">Total Pool Balance</div>
        <div class="pool-stat-value" id="pool-balance">0.00 ETH</div>
      </div>
      <div class="pool-stat">
        <div class="pool-stat-label">Total Bets Placed</div>
        <div class="pool-stat-value" id="total-bets">0</div>
      </div>
      <div class="pool-stat">
        <div class="pool-stat-label">Total Winnings Paid</div>
        <div class="pool-stat-value" id="total-winnings">0.00 ETH</div>
      </div>
    </div>
  </div>
  
  <div class="recent-plays">
    <h3>Your Recent Plays</h3>
    <ul class="play-list" id="recent-plays-list">
      <li class="play-item">
        <span>No game history yet.</span>
      </li>
    </ul>
  </div>
  
  <div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loading-text">Processing your transaction...</div>
  </div>
  
  <div class="modal" id="deposit-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Deposit ETH</h3>
        <button class="modal-close" id="deposit-close">&times;</button>
      </div>
      <div class="modal-body">
        <p>How much ETH would you like to deposit to the pool?</p>
        <div class="amount-input">
          <input type="number" id="deposit-amount" placeholder="0.01" step="0.001" min="0.001">
          <span class="eth-suffix">ETH</span>
        </div>
        <div class="amount-presets">
          <div class="amount-preset" data-amount="0.001">0.001</div>
          <div class="amount-preset" data-amount="0.01">0.01</div>
          <div class="amount-preset" data-amount="0.05">0.05</div>
          <div class="amount-preset" data-amount="0.1">0.1</div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-button cancel" id="deposit-cancel">Cancel</button>
        <button class="modal-button confirm" id="deposit-confirm">Deposit</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="withdraw-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Withdraw ETH</h3>
        <button class="modal-close" id="withdraw-close">&times;</button>
      </div>
      <div class="modal-body">
        <p>How much ETH would you like to withdraw from the pool?</p>
        <div class="amount-input">
          <input type="number" id="withdraw-amount" placeholder="0.01" step="0.001" min="0.001">
          <span class="eth-suffix">ETH</span>
        </div>
        <div class="amount-presets">
          <div class="amount-preset" data-amount="0.001">0.001</div>
          <div class="amount-preset" data-amount="0.01">0.01</div>
          <div class="amount-preset" data-amount="0.05">0.05</div>
          <div class="amount-preset" data-amount="0.1">0.1</div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-button cancel" id="withdraw-cancel">Cancel</button>
        <button class="modal-button confirm" id="withdraw-confirm">Withdraw</button>
      </div>
    </div>
  </div>

  <!-- Farcaster SDK and Ethereum JS libraries -->
  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/frame-sdk';
    import { ethers } from 'https://esm.sh/ethers@6.10.0';
    
    // WheelPool contract ABI
    const contractABI = [
      "function deposit() external payable",
      "function withdraw(uint256 _amount) external",
      "function placeBet(uint8 _choice) external returns (uint256)",
      "function getPlayerBalance(address _player) external view returns (uint256)",
      "function getPlayerBets(address _player) external view returns (uint256[])",
      "function getBetInfo(uint256 _betId) external view returns (address player, uint256 amount, uint8 choice, bool settled, bool won, uint256 payout)",
      "function getPoolInfo() external view returns (uint256 totalBalance, uint256 totalBets, uint256 totalWinnings)",
      "event BetPlaced(uint256 indexed betId, address indexed player, uint256 amount, uint8 choice)",
      "event BetSettled(uint256 indexed betId, address indexed player, bool won, uint256 payout, uint8 result)",
      "event FundsDeposited(address indexed player, uint256 amount)",
      "event FundsWithdrawn(address indexed player, uint256 amount)",
      "event WheelResult(uint256 indexed betId, uint8 result)"
    ];
    
    // Base network settings
    const baseChainId = 8453; // Base Mainnet
    const expectedNetwork = {
      chainId: ethers.toQuantity(baseChainId),
      chainName: "Base",
      nativeCurrency: {
        name: "Ethereum",
        symbol: "ETH",
        decimals: 18
      },
      rpcUrls: ["https://mainnet.base.org"],
      blockExplorerUrls: ["https://basescan.org"]
    };
    
    // Contract address - update after deploying the contract
    const contractAddress = "0xYourContractAddressHere";
    
    // App state
    let provider;
    let signer;
    let contract;
    let userAddress;
    let wheelChoice = null;
    let isSpinning = false;
    let isCorrectNetwork = false;
    let playerBalance = 0;
    let recentPlays = [];
    let poolInfo = {
      totalBalance: 0,
      totalBets: 0,
      totalWinnings: 0
    };
    
    // DOM Elements
    const wheelOptions = document.querySelectorAll('#wheel-options .option');
    const wheelPayoutElement = document.getElementById('wheel-payout');
    const spinButton = document.getElementById('spin-button');
    const wheelResult = document.getElementById('wheel-result');
    const wheelResultText = document.getElementById('wheel-result-text');
    const recentPlaysList = document.getElementById('recent-plays-list');
    const connectWalletButton = document.getElementById('connect-wallet');
    const playerBalanceElement = document.getElementById('player-balance');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const wrongNetworkElement = document.getElementById('wrong-network');
    const switchNetworkButton = document.getElementById('switch-network');
    const wheel = document.getElementById('wheel');
    
    // Pool info elements
    const poolBalanceElement = document.getElementById('pool-balance');
    const totalBetsElement = document.getElementById('total-bets');
    const totalWinningsElement = document.getElementById('total-winnings');
    
    // Modal elements
    const depositButton = document.getElementById('deposit-button');
    const withdrawButton = document.getElementById('withdraw-button');
    const depositModal = document.getElementById('deposit-modal');
    const withdrawModal = document.getElementById('withdraw-modal');
    const depositClose = document.getElementById('deposit-close');
    const withdrawClose = document.getElementById('withdraw-close');
    const depositCancel = document.getElementById('deposit-cancel');
    const withdrawCancel = document.getElementById('withdraw-cancel');
    const depositConfirm = document.getElementById('deposit-confirm');
    const withdrawConfirm = document.getElementById('withdraw-confirm');
    const depositAmount = document.getElementById('deposit-amount');
    const withdrawAmount = document.getElementById('withdraw-amount');
    const depositPresets = depositModal.querySelectorAll('.amount-preset');
    const withdrawPresets = withdrawModal.querySelectorAll('.amount-preset');
    
   // Initialize when Mini App is ready
    document.addEventListener('DOMContentLoaded', async () => {
      // Check for window.ethereum (MetaMask or other injected wallets)
      if (window.ethereum) {
        provider = new ethers.BrowserProvider(window.ethereum);
        
        // Subscribe to chain changes
        window.ethereum.on('chainChanged', handleChainChanged);
        
        // Subscribe to account changes
        window.ethereum.on('accountsChanged', handleAccountsChanged);
        
        // Check if wallet is already connected
        try {
          const accounts = await provider.listAccounts();
          if (accounts.length > 0) {
            await connectWallet();
          }
        } catch (error) {
          console.error("Error checking accounts", error);
        }
      } else {
        connectWalletButton.textContent = "Install MetaMask";
        connectWalletButton.onclick = () => {
          window.open("https://metamask.io/download.html", "_blank");
        };
      }
      
      // Setup event listeners
      setupEventListeners();
    });
    
    async function connectWallet() {
      try {
        loadingOverlay.style.display = "flex";
        loadingText.textContent = "Connecting wallet...";
        
        // Request account access
        const accounts = await provider.send("eth_requestAccounts", []);
        userAddress = accounts[0];
        
        // Get chain ID
        const { chainId } = await provider.getNetwork();
        isCorrectNetwork = Number(chainId) === baseChainId;
        
        if (isCorrectNetwork) {
          signer = await provider.getSigner();
          contract = new ethers.Contract(contractAddress, contractABI, signer);
          
          // Update UI for connected state
          connectWalletButton.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
          connectWalletButton.disabled = true;
          spinButton.classList.remove('disabled');
          wrongNetworkElement.style.display = "none";
          
          // Update player balance
          await updatePlayerBalance();
          
          // Update pool info
          await updatePoolInfo();
          
          // Get player's recent bets
          await loadPlayerBets();
        } else {
          // Show wrong network warning
          wrongNetworkElement.style.display = "block";
        }
      } catch (error) {
        console.error("Error connecting wallet:", error);
      } finally {
        loadingOverlay.style.display = "none";
      }
    }
    
    async function switchToBase() {
      try {
        loadingOverlay.style.display = "flex";
        loadingText.textContent = "Switching network...";
        
        await window.ethereum.request({
          method: "wallet_addEthereumChain",
          params: [expectedNetwork]
        });
        
        isCorrectNetwork = true;
        wrongNetworkElement.style.display = "none";
      } catch (error) {
        console.error("Error switching network:", error);
      } finally {
        loadingOverlay.style.display = "none";
      }
    }
    
    function handleChainChanged() {
      // Reload the page
      window.location.reload();
    }
    
    async function handleAccountsChanged(accounts) {
      if (accounts.length === 0) {
        // User disconnected wallet
        window.location.reload();
      } else {
        // User switched accounts
        userAddress = accounts[0];
        
        if (signer) {
          signer = await provider.getSigner();
          contract = new ethers.Contract(contractAddress, contractABI, signer);
          
          // Update balance
          await updatePlayerBalance();
          
          // Update UI
          connectWalletButton.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
          
          // Load player bets
          await loadPlayerBets();
        }
      }
    }
    
    async function updatePlayerBalance() {
      try {
        // Get player balance from contract
        const balance = await contract.getPlayerBalance(userAddress);
        playerBalance = Number(ethers.formatEther(balance));
        
        // Update UI
        playerBalanceElement.textContent = `${playerBalance.toFixed(4)} ETH`;
        
        // Enable/disable withdraw button based on balance
        if (playerBalance <= 0) {
          withdrawButton.classList.add('disabled');
        } else {
          withdrawButton.classList.remove('disabled');
        }
      } catch (error) {
        console.error("Error getting player balance:", error);
      }
    }
    
    async function updatePoolInfo() {
      try {
        // Get pool info from contract
        const info = await contract.getPoolInfo();
        
        poolInfo = {
          totalBalance: Number(ethers.formatEther(info[0])),
          totalBets: Number(info[1]),
          totalWinnings: Number(ethers.formatEther(info[2]))
        };
        
        // Update UI
        poolBalanceElement.textContent = `${poolInfo.totalBalance.toFixed(4)} ETH`;
        totalBetsElement.textContent = poolInfo.totalBets;
        totalWinningsElement.textContent = `${poolInfo.totalWinnings.toFixed(4)} ETH`;
      } catch (error) {
        console.error("Error getting pool info:", error);
      }
    }
    
    async function loadPlayerBets() {
      try {
        // Get player's bet IDs
        const betIds = await contract.getPlayerBets(userAddress);
        
        // Reset recent plays
        recentPlays = [];
        
        // Get details for each bet (limit to last 5)
        const recentBetIds = betIds.slice(-5).reverse();
        
        for (const betId of recentBetIds) {
          const betInfo = await contract.getBetInfo(betId);
          
          if (betInfo.settled) {
            recentPlays.push({
              id: Number(betId),
              amount: Number(ethers.formatEther(betInfo.amount)),
              choice: betInfo.choice,
              won: betInfo.won,
              payout: Number(ethers.formatEther(betInfo.payout)),
              result: null // We need to get this from events
            });
          }
        }
        
        // Get result for each bet from events
        for (const play of recentPlays) {
          const filter = contract.filters.WheelResult(play.id);
          const events = await contract.queryFilter(filter);
          
          if (events.length > 0) {
            play.result = events[0].args.result;
          }
        }
        
        // Update UI
        updateRecentPlaysUI();
      } catch (error) {
        console.error("Error loading player bets:", error);
      }
    }
    
    function updateRecentPlaysUI() {
      // Clear list
      recentPlaysList.innerHTML = "";
      
      if (recentPlays.length === 0) {
        const emptyItem = document.createElement('li');
        emptyItem.classList.add('play-item');
        emptyItem.innerHTML = `<span>No game history yet.</span>`;
        recentPlaysList.appendChild(emptyItem);
        return;
      }
      
      // Add items
      for (const play of recentPlays) {
        const item = document.createElement('li');
        item.classList.add('play-item');
        
        const resultClass = play.won ? 'win' : 'lose';
        const resultText = play.won ? 'Won' : 'Lost';
        
        item.innerHTML = `
          <span>Bet ${play.amount.toFixed(4)} ETH on ${play.choice}</span>
          <span class="play-result ${resultClass}">
            ${resultText} ${play.won ? `(+${play.payout.toFixed(4)} ETH)` : ''}
            [Result: ${play.result}]
          </span>
        `;
        
        recentPlaysList.appendChild(item);
      }
    }
    
    async function placeBet() {
      if (!wheelChoice) {
        alert("Please select a number first!");
        return;
      }
      
      if (isSpinning) return;
      
      try {
        isSpinning = true;
        loadingOverlay.style.display = "flex";
        loadingText.textContent = "Placing your bet...";
        
        // Disable spin button
        spinButton.classList.add('disabled');
        
        // Place bet
        const tx = await contract.placeBet(wheelChoice);
        
        // Wait for transaction to be mined
        loadingText.textContent = "Waiting for confirmation...";
        await tx.wait();
        
        // Get bet ID from events
        const filter = contract.filters.BetPlaced(null, userAddress);
        const events = await contract.queryFilter(filter, tx.blockNumber, tx.blockNumber);
        
        if (events.length > 0) {
          const betId = events[0].args.betId;
          
          // Start the wheel animation
          spinWheel(betId);
        } else {
          console.error("No BetPlaced event found");
          isSpinning = false;
          loadingOverlay.style.display = "none";
        }
        
        // Update player balance
        await updatePlayerBalance();
        
        // Update pool info
        await updatePoolInfo();
      } catch (error) {
        console.error("Error placing bet:", error);
        alert("Failed to place bet. Please check your balance and try again.");
        isSpinning = false;
        spinButton.classList.remove('disabled');
        loadingOverlay.style.display = "none";
      }
    }
    
    async function spinWheel(betId) {
      try {
        loadingText.textContent = "Spinning the wheel...";
        
        // Listen for result event
        const filter = contract.filters.WheelResult(betId);
        const events = await contract.queryFilter(filter);
        
        if (events.length > 0) {
          const result = events[0].args.result;
          
          // Set random rotation (between 2 and 5 full rotations) plus the specific position
          const fullRotations = 2 + Math.random() * 3;
          const resultPosition = result * 36;
          const rotation = 360 * fullRotations + resultPosition;
          
          // Animate wheel
          wheel.style.transform = `rotate(${rotation}deg)`;
          
          // Wait for animation to complete
          setTimeout(async () => {
            // Check if bet was won
            const betSettledFilter = contract.filters.BetSettled(betId);
            const betSettledEvents = await contract.queryFilter(betSettledFilter);
            
            if (betSettledEvents.length > 0) {
              const event = betSettledEvents[0];
              const won = event.args.won;
              const payout = Number(ethers.formatEther(event.args.payout));
              
              // Show result
              wheelResult.className = 'result-container';
              wheelResult.classList.add(won ? 'result-win' : 'result-loss');
              
              if (won) {
                wheelResultText.textContent = `🎉 Congratulations! You won ${payout.toFixed(4)} ETH!`;
              } else {
                wheelResultText.textContent = `Better luck next time! The result was ${result}.`;
              }
              
              wheelResult.style.display = 'block';
              
              // Update player balance
              await updatePlayerBalance();
              
              // Update pool info
              await updatePoolInfo();
              
              // Reload player bets
              await loadPlayerBets();
            }
            
            // Reset state
            isSpinning = false;
            spinButton.classList.remove('disabled');
            loadingOverlay.style.display = "none";
          }, 3000);
        } else {
          console.error("No WheelResult event found");
          isSpinning = false;
          spinButton.classList.remove('disabled');
          loadingOverlay.style.display = "none";
        }
      } catch (error) {
        console.error("Error spinning wheel:", error);
        isSpinning = false;
        spinButton.classList.remove('disabled');
        loadingOverlay.style.display = "none";
      }
    }
    
    async function depositFunds(amount) {
      try {
        loadingOverlay.style.display = "flex";
        loadingText.textContent = "Processing deposit...";
        
        // Convert amount to wei
        const weiAmount = ethers.parseEther(amount.toString());
        
        // Deposit funds
        const tx = await contract.deposit({ value: weiAmount });
        
        // Wait for transaction to be mined
        loadingText.textContent = "Waiting for confirmation...";
        await tx.wait();
        
        // Update player balance
        await updatePlayerBalance();
        
        // Update pool info
        await updatePoolInfo();
        
        // Hide modal
        depositModal.style.display = "none";
        
        // Reset input
        depositAmount.value = "";
        
        alert("Deposit successful!");
      } catch (error) {
        console.error("Error depositing funds:", error);
        alert("Failed to deposit funds. Please try again.");
      } finally {
        loadingOverlay.style.display = "none";
      }
    }
    
    async function withdrawFunds(amount) {
      try {
        loadingOverlay.style.display = "flex";
        loadingText.textContent = "Processing withdrawal...";
        
        // Convert amount to wei
        const weiAmount = ethers.parseEther(amount.toString());
        
        // Withdraw funds
        const tx = await contract.withdraw(weiAmount);
        
        // Wait for transaction to be mined
        loadingText.textContent = "Waiting for confirmation...";
        await tx.wait();
        
        // Update player balance
        await updatePlayerBalance();
        
        // Update pool info
        await updatePoolInfo();
        
        // Hide modal
        withdrawModal.style.display = "none";
        
        // Reset input
        withdrawAmount.value = "";
        
        alert("Withdrawal successful!");
      } catch (error) {
        console.error("Error withdrawing funds:", error);
        alert("Failed to withdraw funds. Please try again.");
      } finally {
        loadingOverlay.style.display = "none";
      }
    }
    
    function updatePayout() {
      if (wheelChoice !== null) {
        // Fixed payout ratio (9x)
        const potentialWin = 0.001 * 9;
        wheelPayoutElement.textContent = `${potentialWin.toFixed(4)} ETH`;
      } else {
        wheelPayoutElement.textContent = "0.00 ETH";
      }
    }
    
    function setupEventListeners() {
      // Connect wallet button
      connectWalletButton.addEventListener('click', connectWallet);
      
      // Switch network button
      switchNetworkButton.addEventListener('click', switchToBase);
      
      // Wheel options
      wheelOptions.forEach(option => {
        option.addEventListener('click', () => {
          // Remove selected class from all options
          wheelOptions.forEach(opt => opt.classList.remove('selected'));
          
          // Add selected class to clicked option
          option.classList.add('selected');
          
          // Update choice
          wheelChoice = Number(option.getAttribute('data-value'));
          
          // Update potential payout
          updatePayout();
          
          // Enable spin button if not already spinning
          if (!isSpinning) {
            spinButton.classList.remove('disabled');
          }
        });
      });
      
      // Spin button
      spinButton.addEventListener('click', () => {
        if (!spinButton.classList.contains('disabled') && !isSpinning) {
          placeBet();
        }
      });
      
      // Wheel center also triggers spin
      document.querySelector('.wheel-center').addEventListener('click', () => {
        if (!spinButton.classList.contains('disabled') && !isSpinning) {
          placeBet();
        }
      });
      
      // Deposit button
      depositButton.addEventListener('click', () => {
        depositModal.style.display = "flex";
      });
      
      // Withdraw button
      withdrawButton.addEventListener('click', () => {
        if (!withdrawButton.classList.contains('disabled')) {
          withdrawModal.style.display = "flex";
        }
      });
      
      // Close and cancel buttons for modals
      depositClose.addEventListener('click', () => {
        depositModal.style.display = "none";
      });
      
      withdrawClose.addEventListener('click', () => {
        withdrawModal.style.display = "none";
      });
      
      depositCancel.addEventListener('click', () => {
        depositModal.style.display = "none";
      });
      
      withdrawCancel.addEventListener('click', () => {
        withdrawModal.style.display = "none";
      });
      
      // Confirm buttons for modals
      depositConfirm.addEventListener('click', () => {
        const amount = parseFloat(depositAmount.value);
        if (isNaN(amount) || amount <= 0) {
          alert("Please enter a valid amount.");
          return;
        }
        
        depositFunds(amount);
      });
      
      withdrawConfirm.addEventListener('click', () => {
        const amount = parseFloat(withdrawAmount.value);
        if (isNaN(amount) || amount <= 0) {
          alert("Please enter a valid amount.");
          return;
        }
        
        if (amount > playerBalance) {
          alert("You don't have enough balance to withdraw this amount.");
          return;
        }
        
        withdrawFunds(amount);
      });
      
      // Amount presets
      depositPresets.forEach(preset => {
        preset.addEventListener('click', () => {
          depositAmount.value = preset.getAttribute('data-amount');
        });
      });
      
      withdrawPresets.forEach(preset => {
        preset.addEventListener('click', () => {
          withdrawAmount.value = preset.getAttribute('data-amount');
        });
      });
      
      // Close modals when clicking outside
      window.addEventListener('click', (event) => {
        if (event.target === depositModal) {
          depositModal.style.display = "none";
        }
        if (event.target === withdrawModal) {
          withdrawModal.style.display = "none";
        }
      });
    }
  </script>
</body>
</html>
